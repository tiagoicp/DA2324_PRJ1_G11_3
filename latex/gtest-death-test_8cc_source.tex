\doxysection{gtest-\/death-\/test.cc}
\hypertarget{gtest-death-test_8cc_source}{}\label{gtest-death-test_8cc_source}\index{lib/googletest-\/master/googletest/src/gtest-\/death-\/test.cc@{lib/googletest-\/master/googletest/src/gtest-\/death-\/test.cc}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{comment}{//\ Copyright\ 2005,\ Google\ Inc.}}
\DoxyCodeLine{00002\ \textcolor{comment}{//\ All\ rights\ reserved.}}
\DoxyCodeLine{00003\ \textcolor{comment}{//}}
\DoxyCodeLine{00004\ \textcolor{comment}{//\ Redistribution\ and\ use\ in\ source\ and\ binary\ forms,\ with\ or\ without}}
\DoxyCodeLine{00005\ \textcolor{comment}{//\ modification,\ are\ permitted\ provided\ that\ the\ following\ conditions\ are}}
\DoxyCodeLine{00006\ \textcolor{comment}{//\ met:}}
\DoxyCodeLine{00007\ \textcolor{comment}{//}}
\DoxyCodeLine{00008\ \textcolor{comment}{//\ \ \ \ \ *\ Redistributions\ of\ source\ code\ must\ retain\ the\ above\ copyright}}
\DoxyCodeLine{00009\ \textcolor{comment}{//\ notice,\ this\ list\ of\ conditions\ and\ the\ following\ disclaimer.}}
\DoxyCodeLine{00010\ \textcolor{comment}{//\ \ \ \ \ *\ Redistributions\ in\ binary\ form\ must\ reproduce\ the\ above}}
\DoxyCodeLine{00011\ \textcolor{comment}{//\ copyright\ notice,\ this\ list\ of\ conditions\ and\ the\ following\ disclaimer}}
\DoxyCodeLine{00012\ \textcolor{comment}{//\ in\ the\ documentation\ and/or\ other\ materials\ provided\ with\ the}}
\DoxyCodeLine{00013\ \textcolor{comment}{//\ distribution.}}
\DoxyCodeLine{00014\ \textcolor{comment}{//\ \ \ \ \ *\ Neither\ the\ name\ of\ Google\ Inc.\ nor\ the\ names\ of\ its}}
\DoxyCodeLine{00015\ \textcolor{comment}{//\ contributors\ may\ be\ used\ to\ endorse\ or\ promote\ products\ derived\ from}}
\DoxyCodeLine{00016\ \textcolor{comment}{//\ this\ software\ without\ specific\ prior\ written\ permission.}}
\DoxyCodeLine{00017\ \textcolor{comment}{//}}
\DoxyCodeLine{00018\ \textcolor{comment}{//\ THIS\ SOFTWARE\ IS\ PROVIDED\ BY\ THE\ COPYRIGHT\ HOLDERS\ AND\ CONTRIBUTORS}}
\DoxyCodeLine{00019\ \textcolor{comment}{//\ "{}AS\ IS"{}\ AND\ ANY\ EXPRESS\ OR\ IMPLIED\ WARRANTIES,\ INCLUDING,\ BUT\ NOT}}
\DoxyCodeLine{00020\ \textcolor{comment}{//\ LIMITED\ TO,\ THE\ IMPLIED\ WARRANTIES\ OF\ MERCHANTABILITY\ AND\ FITNESS\ FOR}}
\DoxyCodeLine{00021\ \textcolor{comment}{//\ A\ PARTICULAR\ PURPOSE\ ARE\ DISCLAIMED.\ IN\ NO\ EVENT\ SHALL\ THE\ COPYRIGHT}}
\DoxyCodeLine{00022\ \textcolor{comment}{//\ OWNER\ OR\ CONTRIBUTORS\ BE\ LIABLE\ FOR\ ANY\ DIRECT,\ INDIRECT,\ INCIDENTAL,}}
\DoxyCodeLine{00023\ \textcolor{comment}{//\ SPECIAL,\ EXEMPLARY,\ OR\ CONSEQUENTIAL\ DAMAGES\ (INCLUDING,\ BUT\ NOT}}
\DoxyCodeLine{00024\ \textcolor{comment}{//\ LIMITED\ TO,\ PROCUREMENT\ OF\ SUBSTITUTE\ GOODS\ OR\ SERVICES;\ LOSS\ OF\ USE,}}
\DoxyCodeLine{00025\ \textcolor{comment}{//\ DATA,\ OR\ PROFITS;\ OR\ BUSINESS\ INTERRUPTION)\ HOWEVER\ CAUSED\ AND\ ON\ ANY}}
\DoxyCodeLine{00026\ \textcolor{comment}{//\ THEORY\ OF\ LIABILITY,\ WHETHER\ IN\ CONTRACT,\ STRICT\ LIABILITY,\ OR\ TORT}}
\DoxyCodeLine{00027\ \textcolor{comment}{//\ (INCLUDING\ NEGLIGENCE\ OR\ OTHERWISE)\ ARISING\ IN\ ANY\ WAY\ OUT\ OF\ THE\ USE}}
\DoxyCodeLine{00028\ \textcolor{comment}{//\ OF\ THIS\ SOFTWARE,\ EVEN\ IF\ ADVISED\ OF\ THE\ POSSIBILITY\ OF\ SUCH\ DAMAGE.}}
\DoxyCodeLine{00029\ }
\DoxyCodeLine{00030\ \textcolor{comment}{//}}
\DoxyCodeLine{00031\ \textcolor{comment}{//\ This\ file\ implements\ death\ tests.}}
\DoxyCodeLine{00032\ }
\DoxyCodeLine{00033\ \textcolor{preprocessor}{\#include\ "{}gtest/gtest-\/death-\/test.h"{}}}
\DoxyCodeLine{00034\ }
\DoxyCodeLine{00035\ \textcolor{preprocessor}{\#include\ <functional>}}
\DoxyCodeLine{00036\ \textcolor{preprocessor}{\#include\ <utility>}}
\DoxyCodeLine{00037\ }
\DoxyCodeLine{00038\ \textcolor{preprocessor}{\#include\ "{}gtest/internal/gtest-\/port.h"{}}}
\DoxyCodeLine{00039\ \textcolor{preprocessor}{\#include\ "{}gtest/internal/custom/gtest.h"{}}}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \textcolor{preprocessor}{\#if\ GTEST\_HAS\_DEATH\_TEST}}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_MAC}}
\DoxyCodeLine{00044\ \textcolor{preprocessor}{\#\ \ include\ <crt\_externs.h>}}
\DoxyCodeLine{00045\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_MAC}}
\DoxyCodeLine{00046\ }
\DoxyCodeLine{00047\ \textcolor{preprocessor}{\#\ include\ <errno.h>}}
\DoxyCodeLine{00048\ \textcolor{preprocessor}{\#\ include\ <fcntl.h>}}
\DoxyCodeLine{00049\ \textcolor{preprocessor}{\#\ include\ <limits.h>}}
\DoxyCodeLine{00050\ }
\DoxyCodeLine{00051\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_LINUX}}
\DoxyCodeLine{00052\ \textcolor{preprocessor}{\#\ \ include\ <signal.h>}}
\DoxyCodeLine{00053\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_LINUX}}
\DoxyCodeLine{00054\ }
\DoxyCodeLine{00055\ \textcolor{preprocessor}{\#\ include\ <stdarg.h>}}
\DoxyCodeLine{00056\ }
\DoxyCodeLine{00057\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_WINDOWS}}
\DoxyCodeLine{00058\ \textcolor{preprocessor}{\#\ \ include\ <windows.h>}}
\DoxyCodeLine{00059\ \textcolor{preprocessor}{\#\ else}}
\DoxyCodeLine{00060\ \textcolor{preprocessor}{\#\ \ include\ <sys/mman.h>}}
\DoxyCodeLine{00061\ \textcolor{preprocessor}{\#\ \ include\ <sys/wait.h>}}
\DoxyCodeLine{00062\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_WINDOWS}}
\DoxyCodeLine{00063\ }
\DoxyCodeLine{00064\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_QNX}}
\DoxyCodeLine{00065\ \textcolor{preprocessor}{\#\ \ include\ <spawn.h>}}
\DoxyCodeLine{00066\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_QNX}}
\DoxyCodeLine{00067\ }
\DoxyCodeLine{00068\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00069\ \textcolor{preprocessor}{\#\ \ include\ <lib/fdio/fd.h>}}
\DoxyCodeLine{00070\ \textcolor{preprocessor}{\#\ \ include\ <lib/fdio/io.h>}}
\DoxyCodeLine{00071\ \textcolor{preprocessor}{\#\ \ include\ <lib/fdio/spawn.h>}}
\DoxyCodeLine{00072\ \textcolor{preprocessor}{\#\ \ include\ <lib/zx/channel.h>}}
\DoxyCodeLine{00073\ \textcolor{preprocessor}{\#\ \ include\ <lib/zx/port.h>}}
\DoxyCodeLine{00074\ \textcolor{preprocessor}{\#\ \ include\ <lib/zx/process.h>}}
\DoxyCodeLine{00075\ \textcolor{preprocessor}{\#\ \ include\ <lib/zx/socket.h>}}
\DoxyCodeLine{00076\ \textcolor{preprocessor}{\#\ \ include\ <zircon/processargs.h>}}
\DoxyCodeLine{00077\ \textcolor{preprocessor}{\#\ \ include\ <zircon/syscalls.h>}}
\DoxyCodeLine{00078\ \textcolor{preprocessor}{\#\ \ include\ <zircon/syscalls/policy.h>}}
\DoxyCodeLine{00079\ \textcolor{preprocessor}{\#\ \ include\ <zircon/syscalls/port.h>}}
\DoxyCodeLine{00080\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00081\ }
\DoxyCodeLine{00082\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ GTEST\_HAS\_DEATH\_TEST}}
\DoxyCodeLine{00083\ }
\DoxyCodeLine{00084\ \textcolor{preprocessor}{\#include\ "{}gtest/gtest-\/message.h"{}}}
\DoxyCodeLine{00085\ \textcolor{preprocessor}{\#include\ "{}gtest/internal/gtest-\/string.h"{}}}
\DoxyCodeLine{00086\ \textcolor{preprocessor}{\#include\ "{}src/gtest-\/internal-\/inl.h"{}}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \textcolor{keyword}{namespace\ }testing\ \{}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \textcolor{comment}{//\ Constants.}}
\DoxyCodeLine{00091\ }
\DoxyCodeLine{00092\ \textcolor{comment}{//\ The\ default\ death\ test\ style.}}
\DoxyCodeLine{00093\ \textcolor{comment}{//}}
\DoxyCodeLine{00094\ \textcolor{comment}{//\ This\ is\ defined\ in\ internal/gtest-\/port.h\ as\ "{}fast"{},\ but\ can\ be\ overridden\ by}}
\DoxyCodeLine{00095\ \textcolor{comment}{//\ a\ definition\ in\ internal/custom/gtest-\/port.h.\ The\ recommended\ value,\ which\ is}}
\DoxyCodeLine{00096\ \textcolor{comment}{//\ used\ internally\ at\ Google,\ is\ "{}threadsafe"{}.}}
\DoxyCodeLine{00097\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ kDefaultDeathTestStyle[]\ =\ GTEST\_DEFAULT\_DEATH\_TEST\_STYLE;}
\DoxyCodeLine{00098\ }
\DoxyCodeLine{00099\ \}\ \ \textcolor{comment}{//\ namespace\ testing}}
\DoxyCodeLine{00100\ }
\DoxyCodeLine{00101\ GTEST\_DEFINE\_string\_(}
\DoxyCodeLine{00102\ \ \ \ \ death\_test\_style,}
\DoxyCodeLine{00103\ \ \ \ \ testing::internal::StringFromGTestEnv(\textcolor{stringliteral}{"{}death\_test\_style"{}},}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ testing::kDefaultDeathTestStyle),}
\DoxyCodeLine{00105\ \ \ \ \ \textcolor{stringliteral}{"{}Indicates\ how\ to\ run\ a\ death\ test\ in\ a\ forked\ child\ process:\ "{}}}
\DoxyCodeLine{00106\ \ \ \ \ \textcolor{stringliteral}{"{}\(\backslash\)"{}threadsafe\(\backslash\)"{}\ (child\ process\ re-\/executes\ the\ test\ binary\ "{}}}
\DoxyCodeLine{00107\ \ \ \ \ \textcolor{stringliteral}{"{}from\ the\ beginning,\ running\ only\ the\ specific\ death\ test)\ or\ "{}}}
\DoxyCodeLine{00108\ \ \ \ \ \textcolor{stringliteral}{"{}\(\backslash\)"{}fast\(\backslash\)"{}\ (child\ process\ runs\ the\ death\ test\ immediately\ "{}}}
\DoxyCodeLine{00109\ \ \ \ \ \textcolor{stringliteral}{"{}after\ forking)."{}});}
\DoxyCodeLine{00110\ }
\DoxyCodeLine{00111\ GTEST\_DEFINE\_bool\_(}
\DoxyCodeLine{00112\ \ \ \ \ death\_test\_use\_fork,}
\DoxyCodeLine{00113\ \ \ \ \ testing::internal::BoolFromGTestEnv(\textcolor{stringliteral}{"{}death\_test\_use\_fork"{}},\ \textcolor{keyword}{false}),}
\DoxyCodeLine{00114\ \ \ \ \ \textcolor{stringliteral}{"{}Instructs\ to\ use\ fork()/\_exit()\ instead\ of\ clone()\ in\ death\ tests.\ "{}}}
\DoxyCodeLine{00115\ \ \ \ \ \textcolor{stringliteral}{"{}Ignored\ and\ always\ uses\ fork()\ on\ POSIX\ systems\ where\ clone()\ is\ not\ "{}}}
\DoxyCodeLine{00116\ \ \ \ \ \textcolor{stringliteral}{"{}implemented.\ Useful\ when\ running\ under\ valgrind\ or\ similar\ tools\ if\ "{}}}
\DoxyCodeLine{00117\ \ \ \ \ \textcolor{stringliteral}{"{}those\ do\ not\ support\ clone().\ Valgrind\ 3.3.1\ will\ just\ fail\ if\ "{}}}
\DoxyCodeLine{00118\ \ \ \ \ \textcolor{stringliteral}{"{}it\ sees\ an\ unsupported\ combination\ of\ clone()\ flags.\ "{}}}
\DoxyCodeLine{00119\ \ \ \ \ \textcolor{stringliteral}{"{}It\ is\ not\ recommended\ to\ use\ this\ flag\ w/o\ valgrind\ though\ it\ will\ "{}}}
\DoxyCodeLine{00120\ \ \ \ \ \textcolor{stringliteral}{"{}work\ in\ 99\%\ of\ the\ cases.\ Once\ valgrind\ is\ fixed,\ this\ flag\ will\ "{}}}
\DoxyCodeLine{00121\ \ \ \ \ \textcolor{stringliteral}{"{}most\ likely\ be\ removed."{}});}
\DoxyCodeLine{00122\ }
\DoxyCodeLine{00123\ GTEST\_DEFINE\_string\_(}
\DoxyCodeLine{00124\ \ \ \ \ internal\_run\_death\_test,\ \textcolor{stringliteral}{"{}"{}},}
\DoxyCodeLine{00125\ \ \ \ \ \textcolor{stringliteral}{"{}Indicates\ the\ file,\ line\ number,\ temporal\ index\ of\ "{}}}
\DoxyCodeLine{00126\ \ \ \ \ \textcolor{stringliteral}{"{}the\ single\ death\ test\ to\ run,\ and\ a\ file\ descriptor\ to\ "{}}}
\DoxyCodeLine{00127\ \ \ \ \ \textcolor{stringliteral}{"{}which\ a\ success\ code\ may\ be\ sent,\ all\ separated\ by\ "{}}}
\DoxyCodeLine{00128\ \ \ \ \ \textcolor{stringliteral}{"{}the\ '|'\ characters.\ \ This\ flag\ is\ specified\ if\ and\ only\ if\ the\ "{}}}
\DoxyCodeLine{00129\ \ \ \ \ \textcolor{stringliteral}{"{}current\ process\ is\ a\ sub-\/process\ launched\ for\ running\ a\ thread-\/safe\ "{}}}
\DoxyCodeLine{00130\ \ \ \ \ \textcolor{stringliteral}{"{}death\ test.\ \ FOR\ INTERNAL\ USE\ ONLY."{}});}
\DoxyCodeLine{00131\ }
\DoxyCodeLine{00132\ \textcolor{keyword}{namespace\ }testing\ \{}
\DoxyCodeLine{00133\ }
\DoxyCodeLine{00134\ \textcolor{preprocessor}{\#if\ GTEST\_HAS\_DEATH\_TEST}}
\DoxyCodeLine{00135\ }
\DoxyCodeLine{00136\ \textcolor{keyword}{namespace\ }internal\ \{}
\DoxyCodeLine{00137\ }
\DoxyCodeLine{00138\ \textcolor{comment}{//\ Valid\ only\ for\ fast\ death\ tests.\ Indicates\ the\ code\ is\ running\ in\ the}}
\DoxyCodeLine{00139\ \textcolor{comment}{//\ child\ process\ of\ a\ fast\ style\ death\ test.}}
\DoxyCodeLine{00140\ \textcolor{preprocessor}{\#\ if\ !GTEST\_OS\_WINDOWS\ \&\&\ !GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00141\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ g\_in\_fast\_death\_test\_child\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00142\ \textcolor{preprocessor}{\#\ endif}}
\DoxyCodeLine{00143\ }
\DoxyCodeLine{00144\ \textcolor{comment}{//\ Returns\ a\ Boolean\ value\ indicating\ whether\ the\ caller\ is\ currently}}
\DoxyCodeLine{00145\ \textcolor{comment}{//\ executing\ in\ the\ context\ of\ the\ death\ test\ child\ process.\ \ Tools\ such\ as}}
\DoxyCodeLine{00146\ \textcolor{comment}{//\ Valgrind\ heap\ checkers\ may\ need\ this\ to\ modify\ their\ behavior\ in\ death}}
\DoxyCodeLine{00147\ \textcolor{comment}{//\ tests.\ \ IMPORTANT:\ This\ is\ an\ internal\ utility.\ \ Using\ it\ may\ break\ the}}
\DoxyCodeLine{00148\ \textcolor{comment}{//\ implementation\ of\ death\ tests.\ \ User\ code\ MUST\ NOT\ use\ it.}}
\DoxyCodeLine{00149\ \textcolor{keywordtype}{bool}\ InDeathTestChild()\ \{}
\DoxyCodeLine{00150\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_WINDOWS\ ||\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00151\ }
\DoxyCodeLine{00152\ \ \ \textcolor{comment}{//\ On\ Windows\ and\ Fuchsia,\ death\ tests\ are\ thread-\/safe\ regardless\ of\ the\ value}}
\DoxyCodeLine{00153\ \ \ \textcolor{comment}{//\ of\ the\ death\_test\_style\ flag.}}
\DoxyCodeLine{00154\ \ \ \textcolor{keywordflow}{return}\ !GTEST\_FLAG\_GET(internal\_run\_death\_test).empty();}
\DoxyCodeLine{00155\ }
\DoxyCodeLine{00156\ \textcolor{preprocessor}{\#\ else}}
\DoxyCodeLine{00157\ }
\DoxyCodeLine{00158\ \ \ \textcolor{keywordflow}{if}\ (GTEST\_FLAG\_GET(death\_test\_style)\ ==\ \textcolor{stringliteral}{"{}threadsafe"{}})}
\DoxyCodeLine{00159\ \ \ \ \ \textcolor{keywordflow}{return}\ !GTEST\_FLAG\_GET(internal\_run\_death\_test).empty();}
\DoxyCodeLine{00160\ \ \ \textcolor{keywordflow}{else}}
\DoxyCodeLine{00161\ \ \ \ \ \textcolor{keywordflow}{return}\ g\_in\_fast\_death\_test\_child;}
\DoxyCodeLine{00162\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00163\ \}}
\DoxyCodeLine{00164\ }
\DoxyCodeLine{00165\ \}\ \ \textcolor{comment}{//\ namespace\ internal}}
\DoxyCodeLine{00166\ }
\DoxyCodeLine{00167\ \textcolor{comment}{//\ ExitedWithCode\ constructor.}}
\DoxyCodeLine{00168\ ExitedWithCode::ExitedWithCode(\textcolor{keywordtype}{int}\ exit\_code)\ :\ exit\_code\_(exit\_code)\ \{}
\DoxyCodeLine{00169\ \}}
\DoxyCodeLine{00170\ }
\DoxyCodeLine{00171\ \textcolor{comment}{//\ ExitedWithCode\ function-\/call\ operator.}}
\DoxyCodeLine{00172\ \textcolor{keywordtype}{bool}\ ExitedWithCode::operator()(\textcolor{keywordtype}{int}\ exit\_status)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00173\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_WINDOWS\ ||\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00174\ }
\DoxyCodeLine{00175\ \ \ \textcolor{keywordflow}{return}\ exit\_status\ ==\ exit\_code\_;}
\DoxyCodeLine{00176\ }
\DoxyCodeLine{00177\ \textcolor{preprocessor}{\#\ else}}
\DoxyCodeLine{00178\ }
\DoxyCodeLine{00179\ \ \ \textcolor{keywordflow}{return}\ WIFEXITED(exit\_status)\ \&\&\ WEXITSTATUS(exit\_status)\ ==\ exit\_code\_;}
\DoxyCodeLine{00180\ }
\DoxyCodeLine{00181\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_WINDOWS\ ||\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00182\ \}}
\DoxyCodeLine{00183\ }
\DoxyCodeLine{00184\ \textcolor{preprocessor}{\#\ if\ !GTEST\_OS\_WINDOWS\ \&\&\ !GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00185\ \textcolor{comment}{//\ KilledBySignal\ constructor.}}
\DoxyCodeLine{00186\ KilledBySignal::KilledBySignal(\textcolor{keywordtype}{int}\ signum)\ :\ signum\_(signum)\ \{}
\DoxyCodeLine{00187\ \}}
\DoxyCodeLine{00188\ }
\DoxyCodeLine{00189\ \textcolor{comment}{//\ KilledBySignal\ function-\/call\ operator.}}
\DoxyCodeLine{00190\ \textcolor{keywordtype}{bool}\ KilledBySignal::operator()(\textcolor{keywordtype}{int}\ exit\_status)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00191\ \textcolor{preprocessor}{\#\ \ if\ defined(GTEST\_KILLED\_BY\_SIGNAL\_OVERRIDE\_)}}
\DoxyCodeLine{00192\ \ \ \{}
\DoxyCodeLine{00193\ \ \ \ \ \textcolor{keywordtype}{bool}\ result;}
\DoxyCodeLine{00194\ \ \ \ \ \textcolor{keywordflow}{if}\ (GTEST\_KILLED\_BY\_SIGNAL\_OVERRIDE\_(signum\_,\ exit\_status,\ \&result))\ \{}
\DoxyCodeLine{00195\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{00196\ \ \ \ \ \}}
\DoxyCodeLine{00197\ \ \ \}}
\DoxyCodeLine{00198\ \textcolor{preprocessor}{\#\ \ endif\ \ }\textcolor{comment}{//\ defined(GTEST\_KILLED\_BY\_SIGNAL\_OVERRIDE\_)}}
\DoxyCodeLine{00199\ \ \ \textcolor{keywordflow}{return}\ WIFSIGNALED(exit\_status)\ \&\&\ WTERMSIG(exit\_status)\ ==\ signum\_;}
\DoxyCodeLine{00200\ \}}
\DoxyCodeLine{00201\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ !GTEST\_OS\_WINDOWS\ \&\&\ !GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00202\ }
\DoxyCodeLine{00203\ \textcolor{keyword}{namespace\ }internal\ \{}
\DoxyCodeLine{00204\ }
\DoxyCodeLine{00205\ \textcolor{comment}{//\ Utilities\ needed\ for\ death\ tests.}}
\DoxyCodeLine{00206\ }
\DoxyCodeLine{00207\ \textcolor{comment}{//\ Generates\ a\ textual\ description\ of\ a\ given\ exit\ code,\ in\ the\ format}}
\DoxyCodeLine{00208\ \textcolor{comment}{//\ specified\ by\ wait(2).}}
\DoxyCodeLine{00209\ \textcolor{keyword}{static}\ std::string\ ExitSummary(\textcolor{keywordtype}{int}\ exit\_code)\ \{}
\DoxyCodeLine{00210\ \ \ Message\ m;}
\DoxyCodeLine{00211\ }
\DoxyCodeLine{00212\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_WINDOWS\ ||\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00213\ }
\DoxyCodeLine{00214\ \ \ m\ <<\ \textcolor{stringliteral}{"{}Exited\ with\ exit\ status\ "{}}\ <<\ exit\_code;}
\DoxyCodeLine{00215\ }
\DoxyCodeLine{00216\ \textcolor{preprocessor}{\#\ else}}
\DoxyCodeLine{00217\ }
\DoxyCodeLine{00218\ \ \ \textcolor{keywordflow}{if}\ (WIFEXITED(exit\_code))\ \{}
\DoxyCodeLine{00219\ \ \ \ \ m\ <<\ \textcolor{stringliteral}{"{}Exited\ with\ exit\ status\ "{}}\ <<\ WEXITSTATUS(exit\_code);}
\DoxyCodeLine{00220\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (WIFSIGNALED(exit\_code))\ \{}
\DoxyCodeLine{00221\ \ \ \ \ m\ <<\ \textcolor{stringliteral}{"{}Terminated\ by\ signal\ "{}}\ <<\ WTERMSIG(exit\_code);}
\DoxyCodeLine{00222\ \ \ \}}
\DoxyCodeLine{00223\ \textcolor{preprocessor}{\#\ \ ifdef\ WCOREDUMP}}
\DoxyCodeLine{00224\ \ \ \textcolor{keywordflow}{if}\ (WCOREDUMP(exit\_code))\ \{}
\DoxyCodeLine{00225\ \ \ \ \ m\ <<\ \textcolor{stringliteral}{"{}\ (core\ dumped)"{}};}
\DoxyCodeLine{00226\ \ \ \}}
\DoxyCodeLine{00227\ \textcolor{preprocessor}{\#\ \ endif}}
\DoxyCodeLine{00228\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_WINDOWS\ ||\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00229\ }
\DoxyCodeLine{00230\ \ \ \textcolor{keywordflow}{return}\ m.GetString();}
\DoxyCodeLine{00231\ \}}
\DoxyCodeLine{00232\ }
\DoxyCodeLine{00233\ \textcolor{comment}{//\ Returns\ true\ if\ exit\_status\ describes\ a\ process\ that\ was\ terminated}}
\DoxyCodeLine{00234\ \textcolor{comment}{//\ by\ a\ signal,\ or\ exited\ normally\ with\ a\ nonzero\ exit\ code.}}
\DoxyCodeLine{00235\ \textcolor{keywordtype}{bool}\ ExitedUnsuccessfully(\textcolor{keywordtype}{int}\ exit\_status)\ \{}
\DoxyCodeLine{00236\ \ \ \textcolor{keywordflow}{return}\ !ExitedWithCode(0)(exit\_status);}
\DoxyCodeLine{00237\ \}}
\DoxyCodeLine{00238\ }
\DoxyCodeLine{00239\ \textcolor{preprocessor}{\#\ if\ !GTEST\_OS\_WINDOWS\ \&\&\ !GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00240\ \textcolor{comment}{//\ Generates\ a\ textual\ failure\ message\ when\ a\ death\ test\ finds\ more\ than}}
\DoxyCodeLine{00241\ \textcolor{comment}{//\ one\ thread\ running,\ or\ cannot\ determine\ the\ number\ of\ threads,\ prior}}
\DoxyCodeLine{00242\ \textcolor{comment}{//\ to\ executing\ the\ given\ statement.\ \ It\ is\ the\ responsibility\ of\ the}}
\DoxyCodeLine{00243\ \textcolor{comment}{//\ caller\ not\ to\ pass\ a\ thread\_count\ of\ 1.}}
\DoxyCodeLine{00244\ \textcolor{keyword}{static}\ std::string\ DeathTestThreadWarning(\textcolor{keywordtype}{size\_t}\ thread\_count)\ \{}
\DoxyCodeLine{00245\ \ \ Message\ msg;}
\DoxyCodeLine{00246\ \ \ msg\ <<\ \textcolor{stringliteral}{"{}Death\ tests\ use\ fork(),\ which\ is\ unsafe\ particularly"{}}}
\DoxyCodeLine{00247\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ in\ a\ threaded\ context.\ For\ this\ test,\ "{}}\ <<\ GTEST\_NAME\_\ <<\ \textcolor{stringliteral}{"{}\ "{}};}
\DoxyCodeLine{00248\ \ \ \textcolor{keywordflow}{if}\ (thread\_count\ ==\ 0)\ \{}
\DoxyCodeLine{00249\ \ \ \ \ msg\ <<\ \textcolor{stringliteral}{"{}couldn't\ detect\ the\ number\ of\ threads."{}};}
\DoxyCodeLine{00250\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00251\ \ \ \ \ msg\ <<\ \textcolor{stringliteral}{"{}detected\ "{}}\ <<\ thread\_count\ <<\ \textcolor{stringliteral}{"{}\ threads."{}};}
\DoxyCodeLine{00252\ \ \ \}}
\DoxyCodeLine{00253\ \ \ msg\ <<\ \textcolor{stringliteral}{"{}\ See\ "{}}}
\DoxyCodeLine{00254\ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}https://github.com/google/googletest/blob/master/docs/"{}}}
\DoxyCodeLine{00255\ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}advanced.md\#death-\/tests-\/and-\/threads"{}}}
\DoxyCodeLine{00256\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ for\ more\ explanation\ and\ suggested\ solutions,\ especially\ if"{}}}
\DoxyCodeLine{00257\ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ this\ is\ the\ last\ message\ you\ see\ before\ your\ test\ times\ out."{}};}
\DoxyCodeLine{00258\ \ \ \textcolor{keywordflow}{return}\ msg.GetString();}
\DoxyCodeLine{00259\ \}}
\DoxyCodeLine{00260\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ !GTEST\_OS\_WINDOWS\ \&\&\ !GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00261\ }
\DoxyCodeLine{00262\ \textcolor{comment}{//\ Flag\ characters\ for\ reporting\ a\ death\ test\ that\ did\ not\ die.}}
\DoxyCodeLine{00263\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ kDeathTestLived\ =\ \textcolor{charliteral}{'L'};}
\DoxyCodeLine{00264\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ kDeathTestReturned\ =\ \textcolor{charliteral}{'R'};}
\DoxyCodeLine{00265\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ kDeathTestThrew\ =\ \textcolor{charliteral}{'T'};}
\DoxyCodeLine{00266\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ kDeathTestInternalError\ =\ \textcolor{charliteral}{'I'};}
\DoxyCodeLine{00267\ }
\DoxyCodeLine{00268\ \textcolor{preprocessor}{\#if\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00269\ }
\DoxyCodeLine{00270\ \textcolor{comment}{//\ File\ descriptor\ used\ for\ the\ pipe\ in\ the\ child\ process.}}
\DoxyCodeLine{00271\ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ kFuchsiaReadPipeFd\ =\ 3;}
\DoxyCodeLine{00272\ }
\DoxyCodeLine{00273\ \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{00274\ }
\DoxyCodeLine{00275\ \textcolor{comment}{//\ An\ enumeration\ describing\ all\ of\ the\ possible\ ways\ that\ a\ death\ test\ can}}
\DoxyCodeLine{00276\ \textcolor{comment}{//\ conclude.\ \ DIED\ means\ that\ the\ process\ died\ while\ executing\ the\ test}}
\DoxyCodeLine{00277\ \textcolor{comment}{//\ code;\ LIVED\ means\ that\ process\ lived\ beyond\ the\ end\ of\ the\ test\ code;}}
\DoxyCodeLine{00278\ \textcolor{comment}{//\ RETURNED\ means\ that\ the\ test\ statement\ attempted\ to\ execute\ a\ return}}
\DoxyCodeLine{00279\ \textcolor{comment}{//\ statement,\ which\ is\ not\ allowed;\ THREW\ means\ that\ the\ test\ statement}}
\DoxyCodeLine{00280\ \textcolor{comment}{//\ returned\ control\ by\ throwing\ an\ exception.\ \ IN\_PROGRESS\ means\ the\ test}}
\DoxyCodeLine{00281\ \textcolor{comment}{//\ has\ not\ yet\ concluded.}}
\DoxyCodeLine{00282\ \textcolor{keyword}{enum}\ DeathTestOutcome\ \{\ IN\_PROGRESS,\ DIED,\ LIVED,\ RETURNED,\ THREW\ \};}
\DoxyCodeLine{00283\ }
\DoxyCodeLine{00284\ \textcolor{comment}{//\ Routine\ for\ aborting\ the\ program\ which\ is\ safe\ to\ call\ from\ an}}
\DoxyCodeLine{00285\ \textcolor{comment}{//\ exec-\/style\ death\ test\ child\ process,\ in\ which\ case\ the\ error}}
\DoxyCodeLine{00286\ \textcolor{comment}{//\ message\ is\ propagated\ back\ to\ the\ parent\ process.\ \ Otherwise,\ the}}
\DoxyCodeLine{00287\ \textcolor{comment}{//\ message\ is\ simply\ printed\ to\ stderr.\ \ In\ either\ case,\ the\ program}}
\DoxyCodeLine{00288\ \textcolor{comment}{//\ then\ exits\ with\ status\ 1.}}
\DoxyCodeLine{00289\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ DeathTestAbort(\textcolor{keyword}{const}\ std::string\&\ message)\ \{}
\DoxyCodeLine{00290\ \ \ \textcolor{comment}{//\ On\ a\ POSIX\ system,\ this\ function\ may\ be\ called\ from\ a\ threadsafe-\/style}}
\DoxyCodeLine{00291\ \ \ \textcolor{comment}{//\ death\ test\ child\ process,\ which\ operates\ on\ a\ very\ small\ stack.\ \ Use}}
\DoxyCodeLine{00292\ \ \ \textcolor{comment}{//\ the\ heap\ for\ any\ additional\ non-\/minuscule\ memory\ requirements.}}
\DoxyCodeLine{00293\ \ \ \textcolor{keyword}{const}\ InternalRunDeathTestFlag*\ \textcolor{keyword}{const}\ flag\ =}
\DoxyCodeLine{00294\ \ \ \ \ \ \ GetUnitTestImpl()-\/>internal\_run\_death\_test\_flag();}
\DoxyCodeLine{00295\ \ \ \textcolor{keywordflow}{if}\ (flag\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00296\ \ \ \ \ FILE*\ parent\ =\ posix::FDOpen(flag-\/>write\_fd(),\ \textcolor{stringliteral}{"{}w"{}});}
\DoxyCodeLine{00297\ \ \ \ \ fputc(kDeathTestInternalError,\ parent);}
\DoxyCodeLine{00298\ \ \ \ \ fprintf(parent,\ \textcolor{stringliteral}{"{}\%s"{}},\ message.c\_str());}
\DoxyCodeLine{00299\ \ \ \ \ fflush(parent);}
\DoxyCodeLine{00300\ \ \ \ \ \_exit(1);}
\DoxyCodeLine{00301\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00302\ \ \ \ \ fprintf(stderr,\ \textcolor{stringliteral}{"{}\%s"{}},\ message.c\_str());}
\DoxyCodeLine{00303\ \ \ \ \ fflush(stderr);}
\DoxyCodeLine{00304\ \ \ \ \ posix::Abort();}
\DoxyCodeLine{00305\ \ \ \}}
\DoxyCodeLine{00306\ \}}
\DoxyCodeLine{00307\ }
\DoxyCodeLine{00308\ \textcolor{comment}{//\ A\ replacement\ for\ CHECK\ that\ calls\ DeathTestAbort\ if\ the\ assertion}}
\DoxyCodeLine{00309\ \textcolor{comment}{//\ fails.}}
\DoxyCodeLine{00310\ \textcolor{preprocessor}{\#\ define\ GTEST\_DEATH\_TEST\_CHECK\_(expression)\ \(\backslash\)}}
\DoxyCodeLine{00311\ \textcolor{preprocessor}{\ \ do\ \{\ \(\backslash\)}}
\DoxyCodeLine{00312\ \textcolor{preprocessor}{\ \ \ \ if\ (!::testing::internal::IsTrue(expression))\ \{\ \(\backslash\)}}
\DoxyCodeLine{00313\ \textcolor{preprocessor}{\ \ \ \ \ \ DeathTestAbort(\ \(\backslash\)}}
\DoxyCodeLine{00314\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ ::std::string("{}CHECK\ failed:\ File\ "{})\ +\ \_\_FILE\_\_\ +\ \ "{},\ line\ "{}\ \(\backslash\)}}
\DoxyCodeLine{00315\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ +\ ::testing::internal::StreamableToString(\_\_LINE\_\_)\ +\ "{}:\ "{}\ \(\backslash\)}}
\DoxyCodeLine{00316\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ +\ \#expression);\ \(\backslash\)}}
\DoxyCodeLine{00317\ \textcolor{preprocessor}{\ \ \ \ \}\ \(\backslash\)}}
\DoxyCodeLine{00318\ \textcolor{preprocessor}{\ \ \}\ while\ (::testing::internal::AlwaysFalse())}}
\DoxyCodeLine{00319\ }
\DoxyCodeLine{00320\ \textcolor{comment}{//\ This\ macro\ is\ similar\ to\ GTEST\_DEATH\_TEST\_CHECK\_,\ but\ it\ is\ meant\ for}}
\DoxyCodeLine{00321\ \textcolor{comment}{//\ evaluating\ any\ system\ call\ that\ fulfills\ two\ conditions:\ it\ must\ return}}
\DoxyCodeLine{00322\ \textcolor{comment}{//\ -\/1\ on\ failure,\ and\ set\ errno\ to\ EINTR\ when\ it\ is\ interrupted\ and}}
\DoxyCodeLine{00323\ \textcolor{comment}{//\ should\ be\ tried\ again.\ \ The\ macro\ expands\ to\ a\ loop\ that\ repeatedly}}
\DoxyCodeLine{00324\ \textcolor{comment}{//\ evaluates\ the\ expression\ as\ long\ as\ it\ evaluates\ to\ -\/1\ and\ sets}}
\DoxyCodeLine{00325\ \textcolor{comment}{//\ errno\ to\ EINTR.\ \ If\ the\ expression\ evaluates\ to\ -\/1\ but\ errno\ is}}
\DoxyCodeLine{00326\ \textcolor{comment}{//\ something\ other\ than\ EINTR,\ DeathTestAbort\ is\ called.}}
\DoxyCodeLine{00327\ \textcolor{preprocessor}{\#\ define\ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(expression)\ \(\backslash\)}}
\DoxyCodeLine{00328\ \textcolor{preprocessor}{\ \ do\ \{\ \(\backslash\)}}
\DoxyCodeLine{00329\ \textcolor{preprocessor}{\ \ \ \ int\ gtest\_retval;\ \(\backslash\)}}
\DoxyCodeLine{00330\ \textcolor{preprocessor}{\ \ \ \ do\ \{\ \(\backslash\)}}
\DoxyCodeLine{00331\ \textcolor{preprocessor}{\ \ \ \ \ \ gtest\_retval\ =\ (expression);\ \(\backslash\)}}
\DoxyCodeLine{00332\ \textcolor{preprocessor}{\ \ \ \ \}\ while\ (gtest\_retval\ ==\ -\/1\ \&\&\ errno\ ==\ EINTR);\ \(\backslash\)}}
\DoxyCodeLine{00333\ \textcolor{preprocessor}{\ \ \ \ if\ (gtest\_retval\ ==\ -\/1)\ \{\ \(\backslash\)}}
\DoxyCodeLine{00334\ \textcolor{preprocessor}{\ \ \ \ \ \ DeathTestAbort(\ \(\backslash\)}}
\DoxyCodeLine{00335\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ ::std::string("{}CHECK\ failed:\ File\ "{})\ +\ \_\_FILE\_\_\ +\ "{},\ line\ "{}\ \(\backslash\)}}
\DoxyCodeLine{00336\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ +\ ::testing::internal::StreamableToString(\_\_LINE\_\_)\ +\ "{}:\ "{}\ \(\backslash\)}}
\DoxyCodeLine{00337\ \textcolor{preprocessor}{\ \ \ \ \ \ \ \ \ \ +\ \#expression\ +\ "{}\ !=\ -\/1"{});\ \(\backslash\)}}
\DoxyCodeLine{00338\ \textcolor{preprocessor}{\ \ \ \ \}\ \(\backslash\)}}
\DoxyCodeLine{00339\ \textcolor{preprocessor}{\ \ \}\ while\ (::testing::internal::AlwaysFalse())}}
\DoxyCodeLine{00340\ }
\DoxyCodeLine{00341\ \textcolor{comment}{//\ Returns\ the\ message\ describing\ the\ last\ system\ error\ in\ errno.}}
\DoxyCodeLine{00342\ std::string\ GetLastErrnoDescription()\ \{}
\DoxyCodeLine{00343\ \ \ \ \ \textcolor{keywordflow}{return}\ errno\ ==\ 0\ ?\ \textcolor{stringliteral}{"{}"{}}\ :\ posix::StrError(errno);}
\DoxyCodeLine{00344\ \}}
\DoxyCodeLine{00345\ }
\DoxyCodeLine{00346\ \textcolor{comment}{//\ This\ is\ called\ from\ a\ death\ test\ parent\ process\ to\ read\ a\ failure}}
\DoxyCodeLine{00347\ \textcolor{comment}{//\ message\ from\ the\ death\ test\ child\ process\ and\ log\ it\ with\ the\ FATAL}}
\DoxyCodeLine{00348\ \textcolor{comment}{//\ severity.\ On\ Windows,\ the\ message\ is\ read\ from\ a\ pipe\ handle.\ On\ other}}
\DoxyCodeLine{00349\ \textcolor{comment}{//\ platforms,\ it\ is\ read\ from\ a\ file\ descriptor.}}
\DoxyCodeLine{00350\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ FailFromInternalError(\textcolor{keywordtype}{int}\ fd)\ \{}
\DoxyCodeLine{00351\ \ \ Message\ error;}
\DoxyCodeLine{00352\ \ \ \textcolor{keywordtype}{char}\ buffer[256];}
\DoxyCodeLine{00353\ \ \ \textcolor{keywordtype}{int}\ num\_read;}
\DoxyCodeLine{00354\ }
\DoxyCodeLine{00355\ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00356\ \ \ \ \ \textcolor{keywordflow}{while}\ ((num\_read\ =\ posix::Read(fd,\ buffer,\ 255))\ >\ 0)\ \{}
\DoxyCodeLine{00357\ \ \ \ \ \ \ buffer[num\_read]\ =\ \textcolor{charliteral}{'\(\backslash\)0'};}
\DoxyCodeLine{00358\ \ \ \ \ \ \ error\ <<\ buffer;}
\DoxyCodeLine{00359\ \ \ \ \ \}}
\DoxyCodeLine{00360\ \ \ \}\ \textcolor{keywordflow}{while}\ (num\_read\ ==\ -\/1\ \&\&\ errno\ ==\ EINTR);}
\DoxyCodeLine{00361\ }
\DoxyCodeLine{00362\ \ \ \textcolor{keywordflow}{if}\ (num\_read\ ==\ 0)\ \{}
\DoxyCodeLine{00363\ \ \ \ \ GTEST\_LOG\_(FATAL)\ <<\ error.GetString();}
\DoxyCodeLine{00364\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00365\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ last\_error\ =\ errno;}
\DoxyCodeLine{00366\ \ \ \ \ GTEST\_LOG\_(FATAL)\ <<\ \textcolor{stringliteral}{"{}Error\ while\ reading\ death\ test\ internal:\ "{}}}
\DoxyCodeLine{00367\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ GetLastErrnoDescription()\ <<\ \textcolor{stringliteral}{"{}\ ["{}}\ <<\ last\_error\ <<\ \textcolor{stringliteral}{"{}]"{}};}
\DoxyCodeLine{00368\ \ \ \}}
\DoxyCodeLine{00369\ \}}
\DoxyCodeLine{00370\ }
\DoxyCodeLine{00371\ \textcolor{comment}{//\ Death\ test\ constructor.\ \ Increments\ the\ running\ death\ test\ count}}
\DoxyCodeLine{00372\ \textcolor{comment}{//\ for\ the\ current\ test.}}
\DoxyCodeLine{00373\ DeathTest::DeathTest()\ \{}
\DoxyCodeLine{00374\ \ \ TestInfo*\ \textcolor{keyword}{const}\ info\ =\ GetUnitTestImpl()-\/>current\_test\_info();}
\DoxyCodeLine{00375\ \ \ \textcolor{keywordflow}{if}\ (info\ ==\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00376\ \ \ \ \ DeathTestAbort(\textcolor{stringliteral}{"{}Cannot\ run\ a\ death\ test\ outside\ of\ a\ TEST\ or\ "{}}}
\DoxyCodeLine{00377\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}TEST\_F\ construct"{}});}
\DoxyCodeLine{00378\ \ \ \}}
\DoxyCodeLine{00379\ \}}
\DoxyCodeLine{00380\ }
\DoxyCodeLine{00381\ \textcolor{comment}{//\ Creates\ and\ returns\ a\ death\ test\ by\ dispatching\ to\ the\ current}}
\DoxyCodeLine{00382\ \textcolor{comment}{//\ death\ test\ factory.}}
\DoxyCodeLine{00383\ \textcolor{keywordtype}{bool}\ DeathTest::Create(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ statement,}
\DoxyCodeLine{00384\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Matcher<const\ std::string\&>\ matcher,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ file,}
\DoxyCodeLine{00385\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{int}\ line,\ DeathTest**\ test)\ \{}
\DoxyCodeLine{00386\ \ \ \textcolor{keywordflow}{return}\ GetUnitTestImpl()-\/>death\_test\_factory()-\/>Create(}
\DoxyCodeLine{00387\ \ \ \ \ \ \ statement,\ std::move(matcher),\ file,\ line,\ test);}
\DoxyCodeLine{00388\ \}}
\DoxyCodeLine{00389\ }
\DoxyCodeLine{00390\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ DeathTest::LastMessage()\ \{}
\DoxyCodeLine{00391\ \ \ \textcolor{keywordflow}{return}\ last\_death\_test\_message\_.c\_str();}
\DoxyCodeLine{00392\ \}}
\DoxyCodeLine{00393\ }
\DoxyCodeLine{00394\ \textcolor{keywordtype}{void}\ DeathTest::set\_last\_death\_test\_message(\textcolor{keyword}{const}\ std::string\&\ message)\ \{}
\DoxyCodeLine{00395\ \ \ last\_death\_test\_message\_\ =\ message;}
\DoxyCodeLine{00396\ \}}
\DoxyCodeLine{00397\ }
\DoxyCodeLine{00398\ std::string\ DeathTest::last\_death\_test\_message\_;}
\DoxyCodeLine{00399\ }
\DoxyCodeLine{00400\ \textcolor{comment}{//\ Provides\ cross\ platform\ implementation\ for\ some\ death\ functionality.}}
\DoxyCodeLine{00401\ \textcolor{keyword}{class\ }DeathTestImpl\ :\ \textcolor{keyword}{public}\ DeathTest\ \{}
\DoxyCodeLine{00402\ \ \textcolor{keyword}{protected}:}
\DoxyCodeLine{00403\ \ \ DeathTestImpl(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ a\_statement,\ Matcher<const\ std::string\&>\ matcher)}
\DoxyCodeLine{00404\ \ \ \ \ \ \ :\ statement\_(a\_statement),}
\DoxyCodeLine{00405\ \ \ \ \ \ \ \ \ matcher\_(std::move(matcher)),}
\DoxyCodeLine{00406\ \ \ \ \ \ \ \ \ spawned\_(false),}
\DoxyCodeLine{00407\ \ \ \ \ \ \ \ \ status\_(-\/1),}
\DoxyCodeLine{00408\ \ \ \ \ \ \ \ \ outcome\_(IN\_PROGRESS),}
\DoxyCodeLine{00409\ \ \ \ \ \ \ \ \ read\_fd\_(-\/1),}
\DoxyCodeLine{00410\ \ \ \ \ \ \ \ \ write\_fd\_(-\/1)\ \{\}}
\DoxyCodeLine{00411\ }
\DoxyCodeLine{00412\ \ \ \textcolor{comment}{//\ read\_fd\_\ is\ expected\ to\ be\ closed\ and\ cleared\ by\ a\ derived\ class.}}
\DoxyCodeLine{00413\ \ \ \string~DeathTestImpl()\textcolor{keyword}{\ override\ }\{\ GTEST\_DEATH\_TEST\_CHECK\_(read\_fd\_\ ==\ -\/1);\ \}}
\DoxyCodeLine{00414\ }
\DoxyCodeLine{00415\ \ \ \textcolor{keywordtype}{void}\ Abort(AbortReason\ reason)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00416\ \ \ \textcolor{keywordtype}{bool}\ Passed(\textcolor{keywordtype}{bool}\ status\_ok)\ \textcolor{keyword}{override};}
\DoxyCodeLine{00417\ }
\DoxyCodeLine{00418\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ statement()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ statement\_;\ \}}
\DoxyCodeLine{00419\ \ \ \textcolor{keywordtype}{bool}\ spawned()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ spawned\_;\ \}}
\DoxyCodeLine{00420\ \ \ \textcolor{keywordtype}{void}\ set\_spawned(\textcolor{keywordtype}{bool}\ is\_spawned)\ \{\ spawned\_\ =\ is\_spawned;\ \}}
\DoxyCodeLine{00421\ \ \ \textcolor{keywordtype}{int}\ status()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ status\_;\ \}}
\DoxyCodeLine{00422\ \ \ \textcolor{keywordtype}{void}\ set\_status(\textcolor{keywordtype}{int}\ a\_status)\ \{\ status\_\ =\ a\_status;\ \}}
\DoxyCodeLine{00423\ \ \ DeathTestOutcome\ outcome()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ outcome\_;\ \}}
\DoxyCodeLine{00424\ \ \ \textcolor{keywordtype}{void}\ set\_outcome(DeathTestOutcome\ an\_outcome)\ \{\ outcome\_\ =\ an\_outcome;\ \}}
\DoxyCodeLine{00425\ \ \ \textcolor{keywordtype}{int}\ read\_fd()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ read\_fd\_;\ \}}
\DoxyCodeLine{00426\ \ \ \textcolor{keywordtype}{void}\ set\_read\_fd(\textcolor{keywordtype}{int}\ fd)\ \{\ read\_fd\_\ =\ fd;\ \}}
\DoxyCodeLine{00427\ \ \ \textcolor{keywordtype}{int}\ write\_fd()\textcolor{keyword}{\ const\ }\{\ \textcolor{keywordflow}{return}\ write\_fd\_;\ \}}
\DoxyCodeLine{00428\ \ \ \textcolor{keywordtype}{void}\ set\_write\_fd(\textcolor{keywordtype}{int}\ fd)\ \{\ write\_fd\_\ =\ fd;\ \}}
\DoxyCodeLine{00429\ }
\DoxyCodeLine{00430\ \ \ \textcolor{comment}{//\ Called\ in\ the\ parent\ process\ only.\ Reads\ the\ result\ code\ of\ the\ death}}
\DoxyCodeLine{00431\ \ \ \textcolor{comment}{//\ test\ child\ process\ via\ a\ pipe,\ interprets\ it\ to\ set\ the\ outcome\_}}
\DoxyCodeLine{00432\ \ \ \textcolor{comment}{//\ member,\ and\ closes\ read\_fd\_.\ \ Outputs\ diagnostics\ and\ terminates\ in}}
\DoxyCodeLine{00433\ \ \ \textcolor{comment}{//\ case\ of\ unexpected\ codes.}}
\DoxyCodeLine{00434\ \ \ \textcolor{keywordtype}{void}\ ReadAndInterpretStatusByte();}
\DoxyCodeLine{00435\ }
\DoxyCodeLine{00436\ \ \ \textcolor{comment}{//\ Returns\ stderr\ output\ from\ the\ child\ process.}}
\DoxyCodeLine{00437\ \ \ \textcolor{keyword}{virtual}\ std::string\ GetErrorLogs();}
\DoxyCodeLine{00438\ }
\DoxyCodeLine{00439\ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00440\ \ \ \textcolor{comment}{//\ The\ textual\ content\ of\ the\ code\ this\ object\ is\ testing.\ \ This\ class}}
\DoxyCodeLine{00441\ \ \ \textcolor{comment}{//\ doesn't\ own\ this\ string\ and\ should\ not\ attempt\ to\ delete\ it.}}
\DoxyCodeLine{00442\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}\ statement\_;}
\DoxyCodeLine{00443\ \ \ \textcolor{comment}{//\ A\ matcher\ that's\ expected\ to\ match\ the\ stderr\ output\ by\ the\ child\ process.}}
\DoxyCodeLine{00444\ \ \ Matcher<const\ std::string\&>\ matcher\_;}
\DoxyCodeLine{00445\ \ \ \textcolor{comment}{//\ True\ if\ the\ death\ test\ child\ process\ has\ been\ successfully\ spawned.}}
\DoxyCodeLine{00446\ \ \ \textcolor{keywordtype}{bool}\ spawned\_;}
\DoxyCodeLine{00447\ \ \ \textcolor{comment}{//\ The\ exit\ status\ of\ the\ child\ process.}}
\DoxyCodeLine{00448\ \ \ \textcolor{keywordtype}{int}\ status\_;}
\DoxyCodeLine{00449\ \ \ \textcolor{comment}{//\ How\ the\ death\ test\ concluded.}}
\DoxyCodeLine{00450\ \ \ DeathTestOutcome\ outcome\_;}
\DoxyCodeLine{00451\ \ \ \textcolor{comment}{//\ Descriptor\ to\ the\ read\ end\ of\ the\ pipe\ to\ the\ child\ process.\ \ It\ is}}
\DoxyCodeLine{00452\ \ \ \textcolor{comment}{//\ always\ -\/1\ in\ the\ child\ process.\ \ The\ child\ keeps\ its\ write\ end\ of\ the}}
\DoxyCodeLine{00453\ \ \ \textcolor{comment}{//\ pipe\ in\ write\_fd\_.}}
\DoxyCodeLine{00454\ \ \ \textcolor{keywordtype}{int}\ read\_fd\_;}
\DoxyCodeLine{00455\ \ \ \textcolor{comment}{//\ Descriptor\ to\ the\ child's\ write\ end\ of\ the\ pipe\ to\ the\ parent\ process.}}
\DoxyCodeLine{00456\ \ \ \textcolor{comment}{//\ It\ is\ always\ -\/1\ in\ the\ parent\ process.\ \ The\ parent\ keeps\ its\ end\ of\ the}}
\DoxyCodeLine{00457\ \ \ \textcolor{comment}{//\ pipe\ in\ read\_fd\_.}}
\DoxyCodeLine{00458\ \ \ \textcolor{keywordtype}{int}\ write\_fd\_;}
\DoxyCodeLine{00459\ \};}
\DoxyCodeLine{00460\ }
\DoxyCodeLine{00461\ \textcolor{comment}{//\ Called\ in\ the\ parent\ process\ only.\ Reads\ the\ result\ code\ of\ the\ death}}
\DoxyCodeLine{00462\ \textcolor{comment}{//\ test\ child\ process\ via\ a\ pipe,\ interprets\ it\ to\ set\ the\ outcome\_}}
\DoxyCodeLine{00463\ \textcolor{comment}{//\ member,\ and\ closes\ read\_fd\_.\ \ Outputs\ diagnostics\ and\ terminates\ in}}
\DoxyCodeLine{00464\ \textcolor{comment}{//\ case\ of\ unexpected\ codes.}}
\DoxyCodeLine{00465\ \textcolor{keywordtype}{void}\ DeathTestImpl::ReadAndInterpretStatusByte()\ \{}
\DoxyCodeLine{00466\ \ \ \textcolor{keywordtype}{char}\ flag;}
\DoxyCodeLine{00467\ \ \ \textcolor{keywordtype}{int}\ bytes\_read;}
\DoxyCodeLine{00468\ }
\DoxyCodeLine{00469\ \ \ \textcolor{comment}{//\ The\ read()\ here\ blocks\ until\ data\ is\ available\ (signifying\ the}}
\DoxyCodeLine{00470\ \ \ \textcolor{comment}{//\ failure\ of\ the\ death\ test)\ or\ until\ the\ pipe\ is\ closed\ (signifying}}
\DoxyCodeLine{00471\ \ \ \textcolor{comment}{//\ its\ success),\ so\ it's\ okay\ to\ call\ this\ in\ the\ parent\ before}}
\DoxyCodeLine{00472\ \ \ \textcolor{comment}{//\ the\ child\ process\ has\ exited.}}
\DoxyCodeLine{00473\ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00474\ \ \ \ \ bytes\_read\ =\ posix::Read(read\_fd(),\ \&flag,\ 1);}
\DoxyCodeLine{00475\ \ \ \}\ \textcolor{keywordflow}{while}\ (bytes\_read\ ==\ -\/1\ \&\&\ errno\ ==\ EINTR);}
\DoxyCodeLine{00476\ }
\DoxyCodeLine{00477\ \ \ \textcolor{keywordflow}{if}\ (bytes\_read\ ==\ 0)\ \{}
\DoxyCodeLine{00478\ \ \ \ \ set\_outcome(DIED);}
\DoxyCodeLine{00479\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (bytes\_read\ ==\ 1)\ \{}
\DoxyCodeLine{00480\ \ \ \ \ \textcolor{keywordflow}{switch}\ (flag)\ \{}
\DoxyCodeLine{00481\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ kDeathTestReturned:}
\DoxyCodeLine{00482\ \ \ \ \ \ \ \ \ set\_outcome(RETURNED);}
\DoxyCodeLine{00483\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00484\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ kDeathTestThrew:}
\DoxyCodeLine{00485\ \ \ \ \ \ \ \ \ set\_outcome(THREW);}
\DoxyCodeLine{00486\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00487\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ kDeathTestLived:}
\DoxyCodeLine{00488\ \ \ \ \ \ \ \ \ set\_outcome(LIVED);}
\DoxyCodeLine{00489\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00490\ \ \ \ \ \ \ \textcolor{keywordflow}{case}\ kDeathTestInternalError:}
\DoxyCodeLine{00491\ \ \ \ \ \ \ \ \ FailFromInternalError(read\_fd());\ \ \textcolor{comment}{//\ Does\ not\ return.}}
\DoxyCodeLine{00492\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00493\ \ \ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00494\ \ \ \ \ \ \ \ \ GTEST\_LOG\_(FATAL)\ <<\ \textcolor{stringliteral}{"{}Death\ test\ child\ process\ reported\ "{}}}
\DoxyCodeLine{00495\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}unexpected\ status\ byte\ ("{}}}
\DoxyCodeLine{00496\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\textcolor{keyword}{>}(flag)\ <<\ \textcolor{stringliteral}{"{})"{}};}
\DoxyCodeLine{00497\ \ \ \ \ \}}
\DoxyCodeLine{00498\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00499\ \ \ \ \ GTEST\_LOG\_(FATAL)\ <<\ \textcolor{stringliteral}{"{}Read\ from\ death\ test\ child\ process\ failed:\ "{}}}
\DoxyCodeLine{00500\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ GetLastErrnoDescription();}
\DoxyCodeLine{00501\ \ \ \}}
\DoxyCodeLine{00502\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(posix::Close(read\_fd()));}
\DoxyCodeLine{00503\ \ \ set\_read\_fd(-\/1);}
\DoxyCodeLine{00504\ \}}
\DoxyCodeLine{00505\ }
\DoxyCodeLine{00506\ std::string\ DeathTestImpl::GetErrorLogs()\ \{}
\DoxyCodeLine{00507\ \ \ \textcolor{keywordflow}{return}\ GetCapturedStderr();}
\DoxyCodeLine{00508\ \}}
\DoxyCodeLine{00509\ }
\DoxyCodeLine{00510\ \textcolor{comment}{//\ Signals\ that\ the\ death\ test\ code\ which\ should\ have\ exited,\ didn't.}}
\DoxyCodeLine{00511\ \textcolor{comment}{//\ Should\ be\ called\ only\ in\ a\ death\ test\ child\ process.}}
\DoxyCodeLine{00512\ \textcolor{comment}{//\ Writes\ a\ status\ byte\ to\ the\ child's\ status\ file\ descriptor,\ then}}
\DoxyCodeLine{00513\ \textcolor{comment}{//\ calls\ \_exit(1).}}
\DoxyCodeLine{00514\ \textcolor{keywordtype}{void}\ DeathTestImpl::Abort(AbortReason\ reason)\ \{}
\DoxyCodeLine{00515\ \ \ \textcolor{comment}{//\ The\ parent\ process\ considers\ the\ death\ test\ to\ be\ a\ failure\ if}}
\DoxyCodeLine{00516\ \ \ \textcolor{comment}{//\ it\ finds\ any\ data\ in\ our\ pipe.\ \ So,\ here\ we\ write\ a\ single\ flag\ byte}}
\DoxyCodeLine{00517\ \ \ \textcolor{comment}{//\ to\ the\ pipe,\ then\ exit.}}
\DoxyCodeLine{00518\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}\ status\_ch\ =}
\DoxyCodeLine{00519\ \ \ \ \ \ \ reason\ ==\ TEST\_DID\_NOT\_DIE\ ?\ kDeathTestLived\ :}
\DoxyCodeLine{00520\ \ \ \ \ \ \ reason\ ==\ TEST\_THREW\_EXCEPTION\ ?\ kDeathTestThrew\ :\ kDeathTestReturned;}
\DoxyCodeLine{00521\ }
\DoxyCodeLine{00522\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(posix::Write(write\_fd(),\ \&status\_ch,\ 1));}
\DoxyCodeLine{00523\ \ \ \textcolor{comment}{//\ We\ are\ leaking\ the\ descriptor\ here\ because\ on\ some\ platforms\ (i.e.,}}
\DoxyCodeLine{00524\ \ \ \textcolor{comment}{//\ when\ built\ as\ Windows\ DLL),\ destructors\ of\ global\ objects\ will\ still}}
\DoxyCodeLine{00525\ \ \ \textcolor{comment}{//\ run\ after\ calling\ \_exit().\ On\ such\ systems,\ write\_fd\_\ will\ be}}
\DoxyCodeLine{00526\ \ \ \textcolor{comment}{//\ indirectly\ closed\ from\ the\ destructor\ of\ UnitTestImpl,\ causing\ double}}
\DoxyCodeLine{00527\ \ \ \textcolor{comment}{//\ close\ if\ it\ is\ also\ closed\ here.\ On\ debug\ configurations,\ double\ close}}
\DoxyCodeLine{00528\ \ \ \textcolor{comment}{//\ may\ assert.\ As\ there\ are\ no\ in-\/process\ buffers\ to\ flush\ here,\ we\ are}}
\DoxyCodeLine{00529\ \ \ \textcolor{comment}{//\ relying\ on\ the\ OS\ to\ close\ the\ descriptor\ after\ the\ process\ terminates}}
\DoxyCodeLine{00530\ \ \ \textcolor{comment}{//\ when\ the\ destructors\ are\ not\ run.}}
\DoxyCodeLine{00531\ \ \ \_exit(1);\ \ \textcolor{comment}{//\ Exits\ w/o\ any\ normal\ exit\ hooks\ (we\ were\ supposed\ to\ crash)}}
\DoxyCodeLine{00532\ \}}
\DoxyCodeLine{00533\ }
\DoxyCodeLine{00534\ \textcolor{comment}{//\ Returns\ an\ indented\ copy\ of\ stderr\ output\ for\ a\ death\ test.}}
\DoxyCodeLine{00535\ \textcolor{comment}{//\ This\ makes\ distinguishing\ death\ test\ output\ lines\ from\ regular\ log\ lines}}
\DoxyCodeLine{00536\ \textcolor{comment}{//\ much\ easier.}}
\DoxyCodeLine{00537\ static\ ::std::string\ FormatDeathTestOutput(const\ ::std::string\&\ output)\ \{}
\DoxyCodeLine{00538\ \ \ ::std::string\ ret;}
\DoxyCodeLine{00539\ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ at\ =\ 0;\ ;\ )\ \{}
\DoxyCodeLine{00540\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ line\_end\ =\ output.find(\textcolor{charliteral}{'\(\backslash\)n'},\ at);}
\DoxyCodeLine{00541\ \ \ \ \ ret\ +=\ \textcolor{stringliteral}{"{}[\ \ DEATH\ \ \ ]\ "{}};}
\DoxyCodeLine{00542\ \ \ \ \ \textcolor{keywordflow}{if}\ (line\_end\ ==\ ::std::string::npos)\ \{}
\DoxyCodeLine{00543\ \ \ \ \ \ \ ret\ +=\ output.substr(at);}
\DoxyCodeLine{00544\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00545\ \ \ \ \ \}}
\DoxyCodeLine{00546\ \ \ \ \ ret\ +=\ output.substr(at,\ line\_end\ +\ 1\ -\/\ at);}
\DoxyCodeLine{00547\ \ \ \ \ at\ =\ line\_end\ +\ 1;}
\DoxyCodeLine{00548\ \ \ \}}
\DoxyCodeLine{00549\ \ \ \textcolor{keywordflow}{return}\ ret;}
\DoxyCodeLine{00550\ \}}
\DoxyCodeLine{00551\ }
\DoxyCodeLine{00552\ \textcolor{comment}{//\ Assesses\ the\ success\ or\ failure\ of\ a\ death\ test,\ using\ both\ private}}
\DoxyCodeLine{00553\ \textcolor{comment}{//\ members\ which\ have\ previously\ been\ set,\ and\ one\ argument:}}
\DoxyCodeLine{00554\ \textcolor{comment}{//}}
\DoxyCodeLine{00555\ \textcolor{comment}{//\ Private\ data\ members:}}
\DoxyCodeLine{00556\ \textcolor{comment}{//\ \ \ outcome:\ \ An\ enumeration\ describing\ how\ the\ death\ test}}
\DoxyCodeLine{00557\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ concluded:\ DIED,\ LIVED,\ THREW,\ or\ RETURNED.\ \ The\ death\ test}}
\DoxyCodeLine{00558\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ fails\ in\ the\ latter\ three\ cases.}}
\DoxyCodeLine{00559\ \textcolor{comment}{//\ \ \ status:\ \ \ The\ exit\ status\ of\ the\ child\ process.\ On\ *nix,\ it\ is\ in\ the}}
\DoxyCodeLine{00560\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ in\ the\ format\ specified\ by\ wait(2).\ On\ Windows,\ this\ is\ the}}
\DoxyCodeLine{00561\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ value\ supplied\ to\ the\ ExitProcess()\ API\ or\ a\ numeric\ code}}
\DoxyCodeLine{00562\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ of\ the\ exception\ that\ terminated\ the\ program.}}
\DoxyCodeLine{00563\ \textcolor{comment}{//\ \ \ matcher\_:\ A\ matcher\ that's\ expected\ to\ match\ the\ stderr\ output\ by\ the\ child}}
\DoxyCodeLine{00564\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ process.}}
\DoxyCodeLine{00565\ \textcolor{comment}{//}}
\DoxyCodeLine{00566\ \textcolor{comment}{//\ Argument:}}
\DoxyCodeLine{00567\ \textcolor{comment}{//\ \ \ status\_ok:\ true\ if\ exit\_status\ is\ acceptable\ in\ the\ context\ of}}
\DoxyCodeLine{00568\ \textcolor{comment}{//\ \ \ \ \ \ \ \ \ \ \ \ \ \ this\ particular\ death\ test,\ which\ fails\ if\ it\ is\ false}}
\DoxyCodeLine{00569\ \textcolor{comment}{//}}
\DoxyCodeLine{00570\ \textcolor{comment}{//\ Returns\ true\ if\ and\ only\ if\ all\ of\ the\ above\ conditions\ are\ met.\ \ Otherwise,}}
\DoxyCodeLine{00571\ \textcolor{comment}{//\ the\ first\ failing\ condition,\ in\ the\ order\ given\ above,\ is\ the\ one\ that\ is}}
\DoxyCodeLine{00572\ \textcolor{comment}{//\ reported.\ Also\ sets\ the\ last\ death\ test\ message\ string.}}
\DoxyCodeLine{00573\ \textcolor{keywordtype}{bool}\ DeathTestImpl::Passed(\textcolor{keywordtype}{bool}\ status\_ok)\ \{}
\DoxyCodeLine{00574\ \ \ \textcolor{keywordflow}{if}\ (!spawned())}
\DoxyCodeLine{00575\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{00576\ }
\DoxyCodeLine{00577\ \ \ \textcolor{keyword}{const}\ std::string\ error\_message\ =\ GetErrorLogs();}
\DoxyCodeLine{00578\ }
\DoxyCodeLine{00579\ \ \ \textcolor{keywordtype}{bool}\ success\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00580\ \ \ Message\ buffer;}
\DoxyCodeLine{00581\ }
\DoxyCodeLine{00582\ \ \ buffer\ <<\ \textcolor{stringliteral}{"{}Death\ test:\ "{}}\ <<\ statement()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{00583\ \ \ \textcolor{keywordflow}{switch}\ (outcome())\ \{}
\DoxyCodeLine{00584\ \ \ \ \ \textcolor{keywordflow}{case}\ LIVED:}
\DoxyCodeLine{00585\ \ \ \ \ \ \ buffer\ <<\ \textcolor{stringliteral}{"{}\ \ \ \ Result:\ failed\ to\ die.\(\backslash\)n"{}}}
\DoxyCodeLine{00586\ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ Error\ msg:\(\backslash\)n"{}}\ <<\ FormatDeathTestOutput(error\_message);}
\DoxyCodeLine{00587\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00588\ \ \ \ \ \textcolor{keywordflow}{case}\ THREW:}
\DoxyCodeLine{00589\ \ \ \ \ \ \ buffer\ <<\ \textcolor{stringliteral}{"{}\ \ \ \ Result:\ threw\ an\ exception.\(\backslash\)n"{}}}
\DoxyCodeLine{00590\ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ Error\ msg:\(\backslash\)n"{}}\ <<\ FormatDeathTestOutput(error\_message);}
\DoxyCodeLine{00591\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00592\ \ \ \ \ \textcolor{keywordflow}{case}\ RETURNED:}
\DoxyCodeLine{00593\ \ \ \ \ \ \ buffer\ <<\ \textcolor{stringliteral}{"{}\ \ \ \ Result:\ illegal\ return\ in\ test\ statement.\(\backslash\)n"{}}}
\DoxyCodeLine{00594\ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ Error\ msg:\(\backslash\)n"{}}\ <<\ FormatDeathTestOutput(error\_message);}
\DoxyCodeLine{00595\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00596\ \ \ \ \ \textcolor{keywordflow}{case}\ DIED:}
\DoxyCodeLine{00597\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (status\_ok)\ \{}
\DoxyCodeLine{00598\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (matcher\_.Matches(error\_message))\ \{}
\DoxyCodeLine{00599\ \ \ \ \ \ \ \ \ \ \ success\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00600\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00601\ \ \ \ \ \ \ \ \ \ \ std::ostringstream\ stream;}
\DoxyCodeLine{00602\ \ \ \ \ \ \ \ \ \ \ matcher\_.DescribeTo(\&stream);}
\DoxyCodeLine{00603\ \ \ \ \ \ \ \ \ \ \ buffer\ <<\ \textcolor{stringliteral}{"{}\ \ \ \ Result:\ died\ but\ not\ with\ expected\ error.\(\backslash\)n"{}}}
\DoxyCodeLine{00604\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ Expected:\ "{}}\ <<\ stream.str()\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}}}
\DoxyCodeLine{00605\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Actual\ msg:\(\backslash\)n"{}}}
\DoxyCodeLine{00606\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ FormatDeathTestOutput(error\_message);}
\DoxyCodeLine{00607\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00608\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00609\ \ \ \ \ \ \ \ \ buffer\ <<\ \textcolor{stringliteral}{"{}\ \ \ \ Result:\ died\ but\ not\ with\ expected\ exit\ code:\(\backslash\)n"{}}}
\DoxyCodeLine{00610\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}\ \ \ \ \ \ \ \ \ \ \ \ "{}}\ <<\ ExitSummary(status())\ <<\ \textcolor{stringliteral}{"{}\(\backslash\)n"{}}}
\DoxyCodeLine{00611\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}Actual\ msg:\(\backslash\)n"{}}\ <<\ FormatDeathTestOutput(error\_message);}
\DoxyCodeLine{00612\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00613\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00614\ \ \ \ \ \textcolor{keywordflow}{case}\ IN\_PROGRESS:}
\DoxyCodeLine{00615\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00616\ \ \ \ \ \ \ GTEST\_LOG\_(FATAL)}
\DoxyCodeLine{00617\ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}DeathTest::Passed\ somehow\ called\ before\ conclusion\ of\ test"{}};}
\DoxyCodeLine{00618\ \ \ \}}
\DoxyCodeLine{00619\ }
\DoxyCodeLine{00620\ \ \ DeathTest::set\_last\_death\_test\_message(buffer.GetString());}
\DoxyCodeLine{00621\ \ \ \textcolor{keywordflow}{return}\ success;}
\DoxyCodeLine{00622\ \}}
\DoxyCodeLine{00623\ }
\DoxyCodeLine{00624\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_WINDOWS}}
\DoxyCodeLine{00625\ \textcolor{comment}{//\ WindowsDeathTest\ implements\ death\ tests\ on\ Windows.\ Due\ to\ the}}
\DoxyCodeLine{00626\ \textcolor{comment}{//\ specifics\ of\ starting\ new\ processes\ on\ Windows,\ death\ tests\ there\ are}}
\DoxyCodeLine{00627\ \textcolor{comment}{//\ always\ threadsafe,\ and\ Google\ Test\ considers\ the}}
\DoxyCodeLine{00628\ \textcolor{comment}{//\ -\/-\/gtest\_death\_test\_style=fast\ setting\ to\ be\ equivalent\ to}}
\DoxyCodeLine{00629\ \textcolor{comment}{//\ -\/-\/gtest\_death\_test\_style=threadsafe\ there.}}
\DoxyCodeLine{00630\ \textcolor{comment}{//}}
\DoxyCodeLine{00631\ \textcolor{comment}{//\ A\ few\ implementation\ notes:\ \ Like\ the\ Linux\ version,\ the\ Windows}}
\DoxyCodeLine{00632\ \textcolor{comment}{//\ implementation\ uses\ pipes\ for\ child-\/to-\/parent\ communication.\ But\ due\ to}}
\DoxyCodeLine{00633\ \textcolor{comment}{//\ the\ specifics\ of\ pipes\ on\ Windows,\ some\ extra\ steps\ are\ required:}}
\DoxyCodeLine{00634\ \textcolor{comment}{//}}
\DoxyCodeLine{00635\ \textcolor{comment}{//\ 1.\ The\ parent\ creates\ a\ communication\ pipe\ and\ stores\ handles\ to\ both}}
\DoxyCodeLine{00636\ \textcolor{comment}{//\ \ \ \ ends\ of\ it.}}
\DoxyCodeLine{00637\ \textcolor{comment}{//\ 2.\ The\ parent\ starts\ the\ child\ and\ provides\ it\ with\ the\ information}}
\DoxyCodeLine{00638\ \textcolor{comment}{//\ \ \ \ necessary\ to\ acquire\ the\ handle\ to\ the\ write\ end\ of\ the\ pipe.}}
\DoxyCodeLine{00639\ \textcolor{comment}{//\ 3.\ The\ child\ acquires\ the\ write\ end\ of\ the\ pipe\ and\ signals\ the\ parent}}
\DoxyCodeLine{00640\ \textcolor{comment}{//\ \ \ \ using\ a\ Windows\ event.}}
\DoxyCodeLine{00641\ \textcolor{comment}{//\ 4.\ Now\ the\ parent\ can\ release\ the\ write\ end\ of\ the\ pipe\ on\ its\ side.\ If}}
\DoxyCodeLine{00642\ \textcolor{comment}{//\ \ \ \ this\ is\ done\ before\ step\ 3,\ the\ object's\ reference\ count\ goes\ down\ to}}
\DoxyCodeLine{00643\ \textcolor{comment}{//\ \ \ \ 0\ and\ it\ is\ destroyed,\ preventing\ the\ child\ from\ acquiring\ it.\ The}}
\DoxyCodeLine{00644\ \textcolor{comment}{//\ \ \ \ parent\ now\ has\ to\ release\ it,\ or\ read\ operations\ on\ the\ read\ end\ of}}
\DoxyCodeLine{00645\ \textcolor{comment}{//\ \ \ \ the\ pipe\ will\ not\ return\ when\ the\ child\ terminates.}}
\DoxyCodeLine{00646\ \textcolor{comment}{//\ 5.\ The\ parent\ reads\ child's\ output\ through\ the\ pipe\ (outcome\ code\ and}}
\DoxyCodeLine{00647\ \textcolor{comment}{//\ \ \ \ any\ possible\ error\ messages)\ from\ the\ pipe,\ and\ its\ stderr\ and\ then}}
\DoxyCodeLine{00648\ \textcolor{comment}{//\ \ \ \ determines\ whether\ to\ fail\ the\ test.}}
\DoxyCodeLine{00649\ \textcolor{comment}{//}}
\DoxyCodeLine{00650\ \textcolor{comment}{//\ Note:\ to\ distinguish\ Win32\ API\ calls\ from\ the\ local\ method\ and\ function}}
\DoxyCodeLine{00651\ \textcolor{comment}{//\ calls,\ the\ former\ are\ explicitly\ resolved\ in\ the\ global\ namespace.}}
\DoxyCodeLine{00652\ \textcolor{comment}{//}}
\DoxyCodeLine{00653\ \textcolor{keyword}{class\ }WindowsDeathTest\ :\ \textcolor{keyword}{public}\ DeathTestImpl\ \{}
\DoxyCodeLine{00654\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00655\ \ \ WindowsDeathTest(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ a\_statement,\ Matcher<const\ std::string\&>\ matcher,}
\DoxyCodeLine{00656\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ file,\ \textcolor{keywordtype}{int}\ line)}
\DoxyCodeLine{00657\ \ \ \ \ \ \ :\ DeathTestImpl(a\_statement,\ std::move(matcher)),}
\DoxyCodeLine{00658\ \ \ \ \ \ \ \ \ file\_(file),}
\DoxyCodeLine{00659\ \ \ \ \ \ \ \ \ line\_(line)\ \{\}}
\DoxyCodeLine{00660\ }
\DoxyCodeLine{00661\ \ \ \textcolor{comment}{//\ All\ of\ these\ virtual\ functions\ are\ inherited\ from\ DeathTest.}}
\DoxyCodeLine{00662\ \ \ \textcolor{keyword}{virtual}\ \textcolor{keywordtype}{int}\ Wait();}
\DoxyCodeLine{00663\ \ \ \textcolor{keyword}{virtual}\ TestRole\ AssumeRole();}
\DoxyCodeLine{00664\ }
\DoxyCodeLine{00665\ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00666\ \ \ \textcolor{comment}{//\ The\ name\ of\ the\ file\ in\ which\ the\ death\ test\ is\ located.}}
\DoxyCodeLine{00667\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}\ file\_;}
\DoxyCodeLine{00668\ \ \ \textcolor{comment}{//\ The\ line\ number\ on\ which\ the\ death\ test\ is\ located.}}
\DoxyCodeLine{00669\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ line\_;}
\DoxyCodeLine{00670\ \ \ \textcolor{comment}{//\ Handle\ to\ the\ write\ end\ of\ the\ pipe\ to\ the\ child\ process.}}
\DoxyCodeLine{00671\ \ \ AutoHandle\ write\_handle\_;}
\DoxyCodeLine{00672\ \ \ \textcolor{comment}{//\ Child\ process\ handle.}}
\DoxyCodeLine{00673\ \ \ AutoHandle\ child\_handle\_;}
\DoxyCodeLine{00674\ \ \ \textcolor{comment}{//\ Event\ the\ child\ process\ uses\ to\ signal\ the\ parent\ that\ it\ has}}
\DoxyCodeLine{00675\ \ \ \textcolor{comment}{//\ acquired\ the\ handle\ to\ the\ write\ end\ of\ the\ pipe.\ After\ seeing\ this}}
\DoxyCodeLine{00676\ \ \ \textcolor{comment}{//\ event\ the\ parent\ can\ release\ its\ own\ handles\ to\ make\ sure\ its}}
\DoxyCodeLine{00677\ \ \ \textcolor{comment}{//\ ReadFile()\ calls\ return\ when\ the\ child\ terminates.}}
\DoxyCodeLine{00678\ \ \ AutoHandle\ event\_handle\_;}
\DoxyCodeLine{00679\ \};}
\DoxyCodeLine{00680\ }
\DoxyCodeLine{00681\ \textcolor{comment}{//\ Waits\ for\ the\ child\ in\ a\ death\ test\ to\ exit,\ returning\ its\ exit}}
\DoxyCodeLine{00682\ \textcolor{comment}{//\ status,\ or\ 0\ if\ no\ child\ process\ exists.\ \ As\ a\ side\ effect,\ sets\ the}}
\DoxyCodeLine{00683\ \textcolor{comment}{//\ outcome\ data\ member.}}
\DoxyCodeLine{00684\ \textcolor{keywordtype}{int}\ WindowsDeathTest::Wait()\ \{}
\DoxyCodeLine{00685\ \ \ \textcolor{keywordflow}{if}\ (!spawned())}
\DoxyCodeLine{00686\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00687\ }
\DoxyCodeLine{00688\ \ \ \textcolor{comment}{//\ Wait\ until\ the\ child\ either\ signals\ that\ it\ has\ acquired\ the\ write\ end}}
\DoxyCodeLine{00689\ \ \ \textcolor{comment}{//\ of\ the\ pipe\ or\ it\ dies.}}
\DoxyCodeLine{00690\ \ \ \textcolor{keyword}{const}\ HANDLE\ wait\_handles[2]\ =\ \{\ child\_handle\_.Get(),\ event\_handle\_.Get()\ \};}
\DoxyCodeLine{00691\ \ \ \textcolor{keywordflow}{switch}\ (::WaitForMultipleObjects(2,}
\DoxyCodeLine{00692\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ wait\_handles,}
\DoxyCodeLine{00693\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FALSE,\ \ \textcolor{comment}{//\ Waits\ for\ any\ of\ the\ handles.}}
\DoxyCodeLine{00694\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ INFINITE))\ \{}
\DoxyCodeLine{00695\ \ \ \ \ \textcolor{keywordflow}{case}\ WAIT\_OBJECT\_0:}
\DoxyCodeLine{00696\ \ \ \ \ \textcolor{keywordflow}{case}\ WAIT\_OBJECT\_0\ +\ 1:}
\DoxyCodeLine{00697\ \ \ \ \ \ \ \textcolor{keywordflow}{break};}
\DoxyCodeLine{00698\ \ \ \ \ \textcolor{keywordflow}{default}:}
\DoxyCodeLine{00699\ \ \ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(\textcolor{keyword}{false});\ \ \textcolor{comment}{//\ Should\ not\ get\ here.}}
\DoxyCodeLine{00700\ \ \ \}}
\DoxyCodeLine{00701\ }
\DoxyCodeLine{00702\ \ \ \textcolor{comment}{//\ The\ child\ has\ acquired\ the\ write\ end\ of\ the\ pipe\ or\ exited.}}
\DoxyCodeLine{00703\ \ \ \textcolor{comment}{//\ We\ release\ the\ handle\ on\ our\ side\ and\ continue.}}
\DoxyCodeLine{00704\ \ \ write\_handle\_.Reset();}
\DoxyCodeLine{00705\ \ \ event\_handle\_.Reset();}
\DoxyCodeLine{00706\ }
\DoxyCodeLine{00707\ \ \ ReadAndInterpretStatusByte();}
\DoxyCodeLine{00708\ }
\DoxyCodeLine{00709\ \ \ \textcolor{comment}{//\ Waits\ for\ the\ child\ process\ to\ exit\ if\ it\ haven't\ already.\ This}}
\DoxyCodeLine{00710\ \ \ \textcolor{comment}{//\ returns\ immediately\ if\ the\ child\ has\ already\ exited,\ regardless\ of}}
\DoxyCodeLine{00711\ \ \ \textcolor{comment}{//\ whether\ previous\ calls\ to\ WaitForMultipleObjects\ synchronized\ on\ this}}
\DoxyCodeLine{00712\ \ \ \textcolor{comment}{//\ handle\ or\ not.}}
\DoxyCodeLine{00713\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(}
\DoxyCodeLine{00714\ \ \ \ \ \ \ WAIT\_OBJECT\_0\ ==\ ::WaitForSingleObject(child\_handle\_.Get(),}
\DoxyCodeLine{00715\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ INFINITE));}
\DoxyCodeLine{00716\ \ \ DWORD\ status\_code;}
\DoxyCodeLine{00717\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(}
\DoxyCodeLine{00718\ \ \ \ \ \ \ ::GetExitCodeProcess(child\_handle\_.Get(),\ \&status\_code)\ !=\ FALSE);}
\DoxyCodeLine{00719\ \ \ child\_handle\_.Reset();}
\DoxyCodeLine{00720\ \ \ set\_status(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(status\_code));}
\DoxyCodeLine{00721\ \ \ \textcolor{keywordflow}{return}\ status();}
\DoxyCodeLine{00722\ \}}
\DoxyCodeLine{00723\ }
\DoxyCodeLine{00724\ \textcolor{comment}{//\ The\ AssumeRole\ process\ for\ a\ Windows\ death\ test.\ \ It\ creates\ a\ child}}
\DoxyCodeLine{00725\ \textcolor{comment}{//\ process\ with\ the\ same\ executable\ as\ the\ current\ process\ to\ run\ the}}
\DoxyCodeLine{00726\ \textcolor{comment}{//\ death\ test.\ \ The\ child\ process\ is\ given\ the\ -\/-\/gtest\_filter\ and}}
\DoxyCodeLine{00727\ \textcolor{comment}{//\ -\/-\/gtest\_internal\_run\_death\_test\ flags\ such\ that\ it\ knows\ to\ run\ the}}
\DoxyCodeLine{00728\ \textcolor{comment}{//\ current\ death\ test\ only.}}
\DoxyCodeLine{00729\ DeathTest::TestRole\ WindowsDeathTest::AssumeRole()\ \{}
\DoxyCodeLine{00730\ \ \ \textcolor{keyword}{const}\ UnitTestImpl*\ \textcolor{keyword}{const}\ impl\ =\ GetUnitTestImpl();}
\DoxyCodeLine{00731\ \ \ \textcolor{keyword}{const}\ InternalRunDeathTestFlag*\ \textcolor{keyword}{const}\ flag\ =}
\DoxyCodeLine{00732\ \ \ \ \ \ \ impl-\/>internal\_run\_death\_test\_flag();}
\DoxyCodeLine{00733\ \ \ \textcolor{keyword}{const}\ TestInfo*\ \textcolor{keyword}{const}\ info\ =\ impl-\/>current\_test\_info();}
\DoxyCodeLine{00734\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ death\_test\_index\ =\ info-\/>result()-\/>death\_test\_count();}
\DoxyCodeLine{00735\ }
\DoxyCodeLine{00736\ \ \ \textcolor{keywordflow}{if}\ (flag\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00737\ \ \ \ \ \textcolor{comment}{//\ ParseInternalRunDeathTestFlag()\ has\ performed\ all\ the\ necessary}}
\DoxyCodeLine{00738\ \ \ \ \ \textcolor{comment}{//\ processing.}}
\DoxyCodeLine{00739\ \ \ \ \ set\_write\_fd(flag-\/>write\_fd());}
\DoxyCodeLine{00740\ \ \ \ \ \textcolor{keywordflow}{return}\ EXECUTE\_TEST;}
\DoxyCodeLine{00741\ \ \ \}}
\DoxyCodeLine{00742\ }
\DoxyCodeLine{00743\ \ \ \textcolor{comment}{//\ WindowsDeathTest\ uses\ an\ anonymous\ pipe\ to\ communicate\ results\ of}}
\DoxyCodeLine{00744\ \ \ \textcolor{comment}{//\ a\ death\ test.}}
\DoxyCodeLine{00745\ \ \ SECURITY\_ATTRIBUTES\ handles\_are\_inheritable\ =\ \{\textcolor{keyword}{sizeof}(SECURITY\_ATTRIBUTES),}
\DoxyCodeLine{00746\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{nullptr},\ TRUE\};}
\DoxyCodeLine{00747\ \ \ HANDLE\ read\_handle,\ write\_handle;}
\DoxyCodeLine{00748\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(}
\DoxyCodeLine{00749\ \ \ \ \ \ \ ::CreatePipe(\&read\_handle,\ \&write\_handle,\ \&handles\_are\_inheritable,}
\DoxyCodeLine{00750\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0)\ \ \textcolor{comment}{//\ Default\ buffer\ size.}}
\DoxyCodeLine{00751\ \ \ \ \ \ \ !=\ FALSE);}
\DoxyCodeLine{00752\ \ \ set\_read\_fd(::\_open\_osfhandle(\textcolor{keyword}{reinterpret\_cast<}intptr\_t\textcolor{keyword}{>}(read\_handle),}
\DoxyCodeLine{00753\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ O\_RDONLY));}
\DoxyCodeLine{00754\ \ \ write\_handle\_.Reset(write\_handle);}
\DoxyCodeLine{00755\ \ \ event\_handle\_.Reset(::CreateEvent(}
\DoxyCodeLine{00756\ \ \ \ \ \ \ \&handles\_are\_inheritable,}
\DoxyCodeLine{00757\ \ \ \ \ \ \ TRUE,\ \ \ \ \ \ \ \textcolor{comment}{//\ The\ event\ will\ automatically\ reset\ to\ non-\/signaled\ state.}}
\DoxyCodeLine{00758\ \ \ \ \ \ \ FALSE,\ \ \ \ \ \ \textcolor{comment}{//\ The\ initial\ state\ is\ non-\/signalled.}}
\DoxyCodeLine{00759\ \ \ \ \ \ \ \textcolor{keyword}{nullptr}));\ \ \textcolor{comment}{//\ The\ even\ is\ unnamed.}}
\DoxyCodeLine{00760\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(event\_handle\_.Get()\ !=\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00761\ \ \ \textcolor{keyword}{const}\ std::string\ filter\_flag\ =\ std::string(\textcolor{stringliteral}{"{}-\/-\/"{}})\ +\ GTEST\_FLAG\_PREFIX\_\ +}
\DoxyCodeLine{00762\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}filter="{}}\ +\ info-\/>test\_suite\_name()\ +\ \textcolor{stringliteral}{"{}."{}}\ +}
\DoxyCodeLine{00763\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ info-\/>name();}
\DoxyCodeLine{00764\ \ \ \textcolor{keyword}{const}\ std::string\ internal\_flag\ =}
\DoxyCodeLine{00765\ \ \ \ \ \ \ std::string(\textcolor{stringliteral}{"{}-\/-\/"{}})\ +\ GTEST\_FLAG\_PREFIX\_\ +}
\DoxyCodeLine{00766\ \ \ \ \ \ \ \textcolor{stringliteral}{"{}internal\_run\_death\_test="{}}\ +\ file\_\ +\ \textcolor{stringliteral}{"{}|"{}}\ +\ StreamableToString(line\_)\ +}
\DoxyCodeLine{00767\ \ \ \ \ \ \ \textcolor{stringliteral}{"{}|"{}}\ +\ StreamableToString(death\_test\_index)\ +\ \textcolor{stringliteral}{"{}|"{}}\ +}
\DoxyCodeLine{00768\ \ \ \ \ \ \ StreamableToString(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\textcolor{keyword}{>}(::GetCurrentProcessId()))\ +}
\DoxyCodeLine{00769\ \ \ \ \ \ \ \textcolor{comment}{//\ size\_t\ has\ the\ same\ width\ as\ pointers\ on\ both\ 32-\/bit\ and\ 64-\/bit}}
\DoxyCodeLine{00770\ \ \ \ \ \ \ \textcolor{comment}{//\ Windows\ platforms.}}
\DoxyCodeLine{00771\ \ \ \ \ \ \ \textcolor{comment}{//\ See\ http://msdn.microsoft.com/en-\/us/library/tcxf1dw6.aspx.}}
\DoxyCodeLine{00772\ \ \ \ \ \ \ \textcolor{stringliteral}{"{}|"{}}\ +\ StreamableToString(\textcolor{keyword}{reinterpret\_cast<}\textcolor{keywordtype}{size\_t}\textcolor{keyword}{>}(write\_handle))\ +\ \textcolor{stringliteral}{"{}|"{}}\ +}
\DoxyCodeLine{00773\ \ \ \ \ \ \ StreamableToString(\textcolor{keyword}{reinterpret\_cast<}\textcolor{keywordtype}{size\_t}\textcolor{keyword}{>}(event\_handle\_.Get()));}
\DoxyCodeLine{00774\ }
\DoxyCodeLine{00775\ \ \ \textcolor{keywordtype}{char}\ executable\_path[\_MAX\_PATH\ +\ 1];\ \ \textcolor{comment}{//\ NOLINT}}
\DoxyCodeLine{00776\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(\_MAX\_PATH\ +\ 1\ !=\ ::GetModuleFileNameA(\textcolor{keyword}{nullptr},}
\DoxyCodeLine{00777\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ executable\_path,}
\DoxyCodeLine{00778\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \_MAX\_PATH));}
\DoxyCodeLine{00779\ }
\DoxyCodeLine{00780\ \ \ std::string\ command\_line\ =}
\DoxyCodeLine{00781\ \ \ \ \ \ \ std::string(::GetCommandLineA())\ +\ \textcolor{stringliteral}{"{}\ "{}}\ +\ filter\_flag\ +\ \textcolor{stringliteral}{"{}\ \(\backslash\)"{}"{}}\ +}
\DoxyCodeLine{00782\ \ \ \ \ \ \ internal\_flag\ +\ \textcolor{stringliteral}{"{}\(\backslash\)"{}"{}};}
\DoxyCodeLine{00783\ }
\DoxyCodeLine{00784\ \ \ DeathTest::set\_last\_death\_test\_message(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{00785\ }
\DoxyCodeLine{00786\ \ \ CaptureStderr();}
\DoxyCodeLine{00787\ \ \ \textcolor{comment}{//\ Flush\ the\ log\ buffers\ since\ the\ log\ streams\ are\ shared\ with\ the\ child.}}
\DoxyCodeLine{00788\ \ \ FlushInfoLog();}
\DoxyCodeLine{00789\ }
\DoxyCodeLine{00790\ \ \ \textcolor{comment}{//\ The\ child\ process\ will\ share\ the\ standard\ handles\ with\ the\ parent.}}
\DoxyCodeLine{00791\ \ \ STARTUPINFOA\ startup\_info;}
\DoxyCodeLine{00792\ \ \ memset(\&startup\_info,\ 0,\ \textcolor{keyword}{sizeof}(STARTUPINFO));}
\DoxyCodeLine{00793\ \ \ startup\_info.dwFlags\ =\ STARTF\_USESTDHANDLES;}
\DoxyCodeLine{00794\ \ \ startup\_info.hStdInput\ =\ ::GetStdHandle(STD\_INPUT\_HANDLE);}
\DoxyCodeLine{00795\ \ \ startup\_info.hStdOutput\ =\ ::GetStdHandle(STD\_OUTPUT\_HANDLE);}
\DoxyCodeLine{00796\ \ \ startup\_info.hStdError\ =\ ::GetStdHandle(STD\_ERROR\_HANDLE);}
\DoxyCodeLine{00797\ }
\DoxyCodeLine{00798\ \ \ PROCESS\_INFORMATION\ process\_info;}
\DoxyCodeLine{00799\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(}
\DoxyCodeLine{00800\ \ \ \ \ \ \ ::CreateProcessA(}
\DoxyCodeLine{00801\ \ \ \ \ \ \ \ \ \ \ executable\_path,\ \textcolor{keyword}{const\_cast<}\textcolor{keywordtype}{char}*\textcolor{keyword}{>}(command\_line.c\_str()),}
\DoxyCodeLine{00802\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{nullptr},\ \ \textcolor{comment}{//\ Returned\ process\ handle\ is\ not\ inheritable.}}
\DoxyCodeLine{00803\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{nullptr},\ \ \textcolor{comment}{//\ Returned\ thread\ handle\ is\ not\ inheritable.}}
\DoxyCodeLine{00804\ \ \ \ \ \ \ \ \ \ \ TRUE,\ \ \textcolor{comment}{//\ Child\ inherits\ all\ inheritable\ handles\ (for\ write\_handle\_).}}
\DoxyCodeLine{00805\ \ \ \ \ \ \ \ \ \ \ 0x0,\ \ \ \textcolor{comment}{//\ Default\ creation\ flags.}}
\DoxyCodeLine{00806\ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{nullptr},\ \ \textcolor{comment}{//\ Inherit\ the\ parent's\ environment.}}
\DoxyCodeLine{00807\ \ \ \ \ \ \ \ \ \ \ UnitTest::GetInstance()-\/>original\_working\_dir(),\ \&startup\_info,}
\DoxyCodeLine{00808\ \ \ \ \ \ \ \ \ \ \ \&process\_info)\ !=\ FALSE);}
\DoxyCodeLine{00809\ \ \ child\_handle\_.Reset(process\_info.hProcess);}
\DoxyCodeLine{00810\ \ \ ::CloseHandle(process\_info.hThread);}
\DoxyCodeLine{00811\ \ \ set\_spawned(\textcolor{keyword}{true});}
\DoxyCodeLine{00812\ \ \ \textcolor{keywordflow}{return}\ OVERSEE\_TEST;}
\DoxyCodeLine{00813\ \}}
\DoxyCodeLine{00814\ }
\DoxyCodeLine{00815\ \textcolor{preprocessor}{\#\ elif\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{00816\ }
\DoxyCodeLine{00817\ \textcolor{keyword}{class\ }FuchsiaDeathTest\ :\ \textcolor{keyword}{public}\ DeathTestImpl\ \{}
\DoxyCodeLine{00818\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00819\ \ \ FuchsiaDeathTest(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ a\_statement,\ Matcher<const\ std::string\&>\ matcher,}
\DoxyCodeLine{00820\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ file,\ \textcolor{keywordtype}{int}\ line)}
\DoxyCodeLine{00821\ \ \ \ \ \ \ :\ DeathTestImpl(a\_statement,\ std::move(matcher)),}
\DoxyCodeLine{00822\ \ \ \ \ \ \ \ \ file\_(file),}
\DoxyCodeLine{00823\ \ \ \ \ \ \ \ \ line\_(line)\ \{\}}
\DoxyCodeLine{00824\ }
\DoxyCodeLine{00825\ \ \ \textcolor{comment}{//\ All\ of\ these\ virtual\ functions\ are\ inherited\ from\ DeathTest.}}
\DoxyCodeLine{00826\ \ \ \textcolor{keywordtype}{int}\ Wait()\ \textcolor{keyword}{override};}
\DoxyCodeLine{00827\ \ \ TestRole\ AssumeRole()\ \textcolor{keyword}{override};}
\DoxyCodeLine{00828\ \ \ std::string\ GetErrorLogs()\ \textcolor{keyword}{override};}
\DoxyCodeLine{00829\ }
\DoxyCodeLine{00830\ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00831\ \ \ \textcolor{comment}{//\ The\ name\ of\ the\ file\ in\ which\ the\ death\ test\ is\ located.}}
\DoxyCodeLine{00832\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}\ file\_;}
\DoxyCodeLine{00833\ \ \ \textcolor{comment}{//\ The\ line\ number\ on\ which\ the\ death\ test\ is\ located.}}
\DoxyCodeLine{00834\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ line\_;}
\DoxyCodeLine{00835\ \ \ \textcolor{comment}{//\ The\ stderr\ data\ captured\ by\ the\ child\ process.}}
\DoxyCodeLine{00836\ \ \ std::string\ captured\_stderr\_;}
\DoxyCodeLine{00837\ }
\DoxyCodeLine{00838\ \ \ zx::process\ child\_process\_;}
\DoxyCodeLine{00839\ \ \ zx::channel\ exception\_channel\_;}
\DoxyCodeLine{00840\ \ \ zx::socket\ stderr\_socket\_;}
\DoxyCodeLine{00841\ \};}
\DoxyCodeLine{00842\ }
\DoxyCodeLine{00843\ \textcolor{comment}{//\ Utility\ class\ for\ accumulating\ command-\/line\ arguments.}}
\DoxyCodeLine{00844\ \textcolor{keyword}{class\ }Arguments\ \{}
\DoxyCodeLine{00845\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00846\ \ \ Arguments()\ \{\ args\_.push\_back(\textcolor{keyword}{nullptr});\ \}}
\DoxyCodeLine{00847\ }
\DoxyCodeLine{00848\ \ \ \string~Arguments()\ \{}
\DoxyCodeLine{00849\ \ \ \ \ \textcolor{keywordflow}{for}\ (std::vector<char*>::iterator\ i\ =\ args\_.begin();\ i\ !=\ args\_.end();}
\DoxyCodeLine{00850\ \ \ \ \ \ \ \ \ \ ++i)\ \{}
\DoxyCodeLine{00851\ \ \ \ \ \ \ free(*i);}
\DoxyCodeLine{00852\ \ \ \ \ \}}
\DoxyCodeLine{00853\ \ \ \}}
\DoxyCodeLine{00854\ \ \ \textcolor{keywordtype}{void}\ AddArgument(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ argument)\ \{}
\DoxyCodeLine{00855\ \ \ \ \ args\_.insert(args\_.end()\ -\/\ 1,\ posix::StrDup(argument));}
\DoxyCodeLine{00856\ \ \ \}}
\DoxyCodeLine{00857\ }
\DoxyCodeLine{00858\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Str>}
\DoxyCodeLine{00859\ \ \ \textcolor{keywordtype}{void}\ AddArguments(const\ ::std::vector<Str>\&\ arguments)\ \{}
\DoxyCodeLine{00860\ \ \ \ \ \textcolor{keywordflow}{for}\ (typename\ ::std::vector<Str>::const\_iterator\ i\ =\ arguments.begin();}
\DoxyCodeLine{00861\ \ \ \ \ \ \ \ \ \ i\ !=\ arguments.end();}
\DoxyCodeLine{00862\ \ \ \ \ \ \ \ \ \ ++i)\ \{}
\DoxyCodeLine{00863\ \ \ \ \ \ \ args\_.insert(args\_.end()\ -\/\ 1,\ posix::StrDup(i-\/>c\_str()));}
\DoxyCodeLine{00864\ \ \ \ \ \}}
\DoxyCodeLine{00865\ \ \ \}}
\DoxyCodeLine{00866\ \ \ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}*\ Argv()\ \{}
\DoxyCodeLine{00867\ \ \ \ \ \textcolor{keywordflow}{return}\ \&args\_[0];}
\DoxyCodeLine{00868\ \ \ \}}
\DoxyCodeLine{00869\ }
\DoxyCodeLine{00870\ \ \ \textcolor{keywordtype}{int}\ size()\ \{}
\DoxyCodeLine{00871\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(args\_.size())\ -\/\ 1;}
\DoxyCodeLine{00872\ \ \ \}}
\DoxyCodeLine{00873\ }
\DoxyCodeLine{00874\ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00875\ \ \ std::vector<char*>\ args\_;}
\DoxyCodeLine{00876\ \};}
\DoxyCodeLine{00877\ }
\DoxyCodeLine{00878\ \textcolor{comment}{//\ Waits\ for\ the\ child\ in\ a\ death\ test\ to\ exit,\ returning\ its\ exit}}
\DoxyCodeLine{00879\ \textcolor{comment}{//\ status,\ or\ 0\ if\ no\ child\ process\ exists.\ \ As\ a\ side\ effect,\ sets\ the}}
\DoxyCodeLine{00880\ \textcolor{comment}{//\ outcome\ data\ member.}}
\DoxyCodeLine{00881\ \textcolor{keywordtype}{int}\ FuchsiaDeathTest::Wait()\ \{}
\DoxyCodeLine{00882\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ kProcessKey\ =\ 0;}
\DoxyCodeLine{00883\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ kSocketKey\ =\ 1;}
\DoxyCodeLine{00884\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ kExceptionKey\ =\ 2;}
\DoxyCodeLine{00885\ }
\DoxyCodeLine{00886\ \ \ \textcolor{keywordflow}{if}\ (!spawned())}
\DoxyCodeLine{00887\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{00888\ }
\DoxyCodeLine{00889\ \ \ \textcolor{comment}{//\ Create\ a\ port\ to\ wait\ for\ socket/task/exception\ events.}}
\DoxyCodeLine{00890\ \ \ zx\_status\_t\ status\_zx;}
\DoxyCodeLine{00891\ \ \ zx::port\ port;}
\DoxyCodeLine{00892\ \ \ status\_zx\ =\ zx::port::create(0,\ \&port);}
\DoxyCodeLine{00893\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\_zx\ ==\ ZX\_OK);}
\DoxyCodeLine{00894\ }
\DoxyCodeLine{00895\ \ \ \textcolor{comment}{//\ Register\ to\ wait\ for\ the\ child\ process\ to\ terminate.}}
\DoxyCodeLine{00896\ \ \ status\_zx\ =\ child\_process\_.wait\_async(}
\DoxyCodeLine{00897\ \ \ \ \ \ \ port,\ kProcessKey,\ ZX\_PROCESS\_TERMINATED,\ 0);}
\DoxyCodeLine{00898\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\_zx\ ==\ ZX\_OK);}
\DoxyCodeLine{00899\ }
\DoxyCodeLine{00900\ \ \ \textcolor{comment}{//\ Register\ to\ wait\ for\ the\ socket\ to\ be\ readable\ or\ closed.}}
\DoxyCodeLine{00901\ \ \ status\_zx\ =\ stderr\_socket\_.wait\_async(}
\DoxyCodeLine{00902\ \ \ \ \ \ \ port,\ kSocketKey,\ ZX\_SOCKET\_READABLE\ |\ ZX\_SOCKET\_PEER\_CLOSED,\ 0);}
\DoxyCodeLine{00903\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\_zx\ ==\ ZX\_OK);}
\DoxyCodeLine{00904\ }
\DoxyCodeLine{00905\ \ \ \textcolor{comment}{//\ Register\ to\ wait\ for\ an\ exception.}}
\DoxyCodeLine{00906\ \ \ status\_zx\ =\ exception\_channel\_.wait\_async(}
\DoxyCodeLine{00907\ \ \ \ \ \ \ port,\ kExceptionKey,\ ZX\_CHANNEL\_READABLE,\ 0);}
\DoxyCodeLine{00908\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\_zx\ ==\ ZX\_OK);}
\DoxyCodeLine{00909\ }
\DoxyCodeLine{00910\ \ \ \textcolor{keywordtype}{bool}\ process\_terminated\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00911\ \ \ \textcolor{keywordtype}{bool}\ socket\_closed\ =\ \textcolor{keyword}{false};}
\DoxyCodeLine{00912\ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00913\ \ \ \ \ zx\_port\_packet\_t\ packet\ =\ \{\};}
\DoxyCodeLine{00914\ \ \ \ \ status\_zx\ =\ port.wait(zx::time::infinite(),\ \&packet);}
\DoxyCodeLine{00915\ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\_zx\ ==\ ZX\_OK);}
\DoxyCodeLine{00916\ }
\DoxyCodeLine{00917\ \ \ \ \ \textcolor{keywordflow}{if}\ (packet.key\ ==\ kExceptionKey)\ \{}
\DoxyCodeLine{00918\ \ \ \ \ \ \ \textcolor{comment}{//\ Process\ encountered\ an\ exception.\ Kill\ it\ directly\ rather\ than}}
\DoxyCodeLine{00919\ \ \ \ \ \ \ \textcolor{comment}{//\ letting\ other\ handlers\ process\ the\ event.\ We\ will\ get\ a\ kProcessKey}}
\DoxyCodeLine{00920\ \ \ \ \ \ \ \textcolor{comment}{//\ event\ when\ the\ process\ actually\ terminates.}}
\DoxyCodeLine{00921\ \ \ \ \ \ \ status\_zx\ =\ child\_process\_.kill();}
\DoxyCodeLine{00922\ \ \ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\_zx\ ==\ ZX\_OK);}
\DoxyCodeLine{00923\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (packet.key\ ==\ kProcessKey)\ \{}
\DoxyCodeLine{00924\ \ \ \ \ \ \ \textcolor{comment}{//\ Process\ terminated.}}
\DoxyCodeLine{00925\ \ \ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(ZX\_PKT\_IS\_SIGNAL\_ONE(packet.type));}
\DoxyCodeLine{00926\ \ \ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(packet.signal.observed\ \&\ ZX\_PROCESS\_TERMINATED);}
\DoxyCodeLine{00927\ \ \ \ \ \ \ process\_terminated\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00928\ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (packet.key\ ==\ kSocketKey)\ \{}
\DoxyCodeLine{00929\ \ \ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(ZX\_PKT\_IS\_SIGNAL\_ONE(packet.type));}
\DoxyCodeLine{00930\ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (packet.signal.observed\ \&\ ZX\_SOCKET\_READABLE)\ \{}
\DoxyCodeLine{00931\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Read\ data\ from\ the\ socket.}}
\DoxyCodeLine{00932\ \ \ \ \ \ \ \ \ \textcolor{keyword}{constexpr}\ \textcolor{keywordtype}{size\_t}\ kBufferSize\ =\ 1024;}
\DoxyCodeLine{00933\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{do}\ \{}
\DoxyCodeLine{00934\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ old\_length\ =\ captured\_stderr\_.length();}
\DoxyCodeLine{00935\ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ bytes\_read\ =\ 0;}
\DoxyCodeLine{00936\ \ \ \ \ \ \ \ \ \ \ captured\_stderr\_.resize(old\_length\ +\ kBufferSize);}
\DoxyCodeLine{00937\ \ \ \ \ \ \ \ \ \ \ status\_zx\ =\ stderr\_socket\_.read(}
\DoxyCodeLine{00938\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0,\ \&captured\_stderr\_.front()\ +\ old\_length,\ kBufferSize,}
\DoxyCodeLine{00939\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \&bytes\_read);}
\DoxyCodeLine{00940\ \ \ \ \ \ \ \ \ \ \ captured\_stderr\_.resize(old\_length\ +\ bytes\_read);}
\DoxyCodeLine{00941\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{while}\ (status\_zx\ ==\ ZX\_OK);}
\DoxyCodeLine{00942\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (status\_zx\ ==\ ZX\_ERR\_PEER\_CLOSED)\ \{}
\DoxyCodeLine{00943\ \ \ \ \ \ \ \ \ \ \ socket\_closed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00944\ \ \ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00945\ \ \ \ \ \ \ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\_zx\ ==\ ZX\_ERR\_SHOULD\_WAIT);}
\DoxyCodeLine{00946\ \ \ \ \ \ \ \ \ \ \ status\_zx\ =\ stderr\_socket\_.wait\_async(}
\DoxyCodeLine{00947\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ port,\ kSocketKey,\ ZX\_SOCKET\_READABLE\ |\ ZX\_SOCKET\_PEER\_CLOSED,\ 0);}
\DoxyCodeLine{00948\ \ \ \ \ \ \ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\_zx\ ==\ ZX\_OK);}
\DoxyCodeLine{00949\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00950\ \ \ \ \ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{00951\ \ \ \ \ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(packet.signal.observed\ \&\ ZX\_SOCKET\_PEER\_CLOSED);}
\DoxyCodeLine{00952\ \ \ \ \ \ \ \ \ socket\_closed\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{00953\ \ \ \ \ \ \ \}}
\DoxyCodeLine{00954\ \ \ \ \ \}}
\DoxyCodeLine{00955\ \ \ \}\ \textcolor{keywordflow}{while}\ (!process\_terminated\ \&\&\ !socket\_closed);}
\DoxyCodeLine{00956\ }
\DoxyCodeLine{00957\ \ \ ReadAndInterpretStatusByte();}
\DoxyCodeLine{00958\ }
\DoxyCodeLine{00959\ \ \ zx\_info\_process\_t\ buffer;}
\DoxyCodeLine{00960\ \ \ status\_zx\ =\ child\_process\_.get\_info(ZX\_INFO\_PROCESS,\ \&buffer,\ \textcolor{keyword}{sizeof}(buffer),}
\DoxyCodeLine{00961\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{nullptr},\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{00962\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\_zx\ ==\ ZX\_OK);}
\DoxyCodeLine{00963\ }
\DoxyCodeLine{00964\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(buffer.flags\ \&\ ZX\_INFO\_PROCESS\_FLAG\_EXITED);}
\DoxyCodeLine{00965\ \ \ set\_status(\textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(buffer.return\_code));}
\DoxyCodeLine{00966\ \ \ \textcolor{keywordflow}{return}\ status();}
\DoxyCodeLine{00967\ \}}
\DoxyCodeLine{00968\ }
\DoxyCodeLine{00969\ \textcolor{comment}{//\ The\ AssumeRole\ process\ for\ a\ Fuchsia\ death\ test.\ \ It\ creates\ a\ child}}
\DoxyCodeLine{00970\ \textcolor{comment}{//\ process\ with\ the\ same\ executable\ as\ the\ current\ process\ to\ run\ the}}
\DoxyCodeLine{00971\ \textcolor{comment}{//\ death\ test.\ \ The\ child\ process\ is\ given\ the\ -\/-\/gtest\_filter\ and}}
\DoxyCodeLine{00972\ \textcolor{comment}{//\ -\/-\/gtest\_internal\_run\_death\_test\ flags\ such\ that\ it\ knows\ to\ run\ the}}
\DoxyCodeLine{00973\ \textcolor{comment}{//\ current\ death\ test\ only.}}
\DoxyCodeLine{00974\ DeathTest::TestRole\ FuchsiaDeathTest::AssumeRole()\ \{}
\DoxyCodeLine{00975\ \ \ \textcolor{keyword}{const}\ UnitTestImpl*\ \textcolor{keyword}{const}\ impl\ =\ GetUnitTestImpl();}
\DoxyCodeLine{00976\ \ \ \textcolor{keyword}{const}\ InternalRunDeathTestFlag*\ \textcolor{keyword}{const}\ flag\ =}
\DoxyCodeLine{00977\ \ \ \ \ \ \ impl-\/>internal\_run\_death\_test\_flag();}
\DoxyCodeLine{00978\ \ \ \textcolor{keyword}{const}\ TestInfo*\ \textcolor{keyword}{const}\ info\ =\ impl-\/>current\_test\_info();}
\DoxyCodeLine{00979\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ death\_test\_index\ =\ info-\/>result()-\/>death\_test\_count();}
\DoxyCodeLine{00980\ }
\DoxyCodeLine{00981\ \ \ \textcolor{keywordflow}{if}\ (flag\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{00982\ \ \ \ \ \textcolor{comment}{//\ ParseInternalRunDeathTestFlag()\ has\ performed\ all\ the\ necessary}}
\DoxyCodeLine{00983\ \ \ \ \ \textcolor{comment}{//\ processing.}}
\DoxyCodeLine{00984\ \ \ \ \ set\_write\_fd(kFuchsiaReadPipeFd);}
\DoxyCodeLine{00985\ \ \ \ \ \textcolor{keywordflow}{return}\ EXECUTE\_TEST;}
\DoxyCodeLine{00986\ \ \ \}}
\DoxyCodeLine{00987\ }
\DoxyCodeLine{00988\ \ \ \textcolor{comment}{//\ Flush\ the\ log\ buffers\ since\ the\ log\ streams\ are\ shared\ with\ the\ child.}}
\DoxyCodeLine{00989\ \ \ FlushInfoLog();}
\DoxyCodeLine{00990\ }
\DoxyCodeLine{00991\ \ \ \textcolor{comment}{//\ Build\ the\ child\ process\ command\ line.}}
\DoxyCodeLine{00992\ \ \ \textcolor{keyword}{const}\ std::string\ filter\_flag\ =\ std::string(\textcolor{stringliteral}{"{}-\/-\/"{}})\ +\ GTEST\_FLAG\_PREFIX\_\ +}
\DoxyCodeLine{00993\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}filter="{}}\ +\ info-\/>test\_suite\_name()\ +\ \textcolor{stringliteral}{"{}."{}}\ +}
\DoxyCodeLine{00994\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ info-\/>name();}
\DoxyCodeLine{00995\ \ \ \textcolor{keyword}{const}\ std::string\ internal\_flag\ =}
\DoxyCodeLine{00996\ \ \ \ \ \ \ std::string(\textcolor{stringliteral}{"{}-\/-\/"{}})\ +\ GTEST\_FLAG\_PREFIX\_\ +\ kInternalRunDeathTestFlag\ +\ \textcolor{stringliteral}{"{}="{}}}
\DoxyCodeLine{00997\ \ \ \ \ \ \ +\ file\_\ +\ \textcolor{stringliteral}{"{}|"{}}}
\DoxyCodeLine{00998\ \ \ \ \ \ \ +\ StreamableToString(line\_)\ +\ \textcolor{stringliteral}{"{}|"{}}}
\DoxyCodeLine{00999\ \ \ \ \ \ \ +\ StreamableToString(death\_test\_index);}
\DoxyCodeLine{01000\ \ \ Arguments\ args;}
\DoxyCodeLine{01001\ \ \ args.AddArguments(GetInjectableArgvs());}
\DoxyCodeLine{01002\ \ \ args.AddArgument(filter\_flag.c\_str());}
\DoxyCodeLine{01003\ \ \ args.AddArgument(internal\_flag.c\_str());}
\DoxyCodeLine{01004\ }
\DoxyCodeLine{01005\ \ \ \textcolor{comment}{//\ Build\ the\ pipe\ for\ communication\ with\ the\ child.}}
\DoxyCodeLine{01006\ \ \ zx\_status\_t\ status;}
\DoxyCodeLine{01007\ \ \ zx\_handle\_t\ child\_pipe\_handle;}
\DoxyCodeLine{01008\ \ \ \textcolor{keywordtype}{int}\ child\_pipe\_fd;}
\DoxyCodeLine{01009\ \ \ status\ =\ fdio\_pipe\_half(\&child\_pipe\_fd,\ \&child\_pipe\_handle);}
\DoxyCodeLine{01010\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\ ==\ ZX\_OK);}
\DoxyCodeLine{01011\ \ \ set\_read\_fd(child\_pipe\_fd);}
\DoxyCodeLine{01012\ }
\DoxyCodeLine{01013\ \ \ \textcolor{comment}{//\ Set\ the\ pipe\ handle\ for\ the\ child.}}
\DoxyCodeLine{01014\ \ \ fdio\_spawn\_action\_t\ spawn\_actions[2]\ =\ \{\};}
\DoxyCodeLine{01015\ \ \ fdio\_spawn\_action\_t*\ add\_handle\_action\ =\ \&spawn\_actions[0];}
\DoxyCodeLine{01016\ \ \ add\_handle\_action-\/>action\ =\ FDIO\_SPAWN\_ACTION\_ADD\_HANDLE;}
\DoxyCodeLine{01017\ \ \ add\_handle\_action-\/>h.id\ =\ PA\_HND(PA\_FD,\ kFuchsiaReadPipeFd);}
\DoxyCodeLine{01018\ \ \ add\_handle\_action-\/>h.handle\ =\ child\_pipe\_handle;}
\DoxyCodeLine{01019\ }
\DoxyCodeLine{01020\ \ \ \textcolor{comment}{//\ Create\ a\ socket\ pair\ will\ be\ used\ to\ receive\ the\ child\ process'\ stderr.}}
\DoxyCodeLine{01021\ \ \ zx::socket\ stderr\_producer\_socket;}
\DoxyCodeLine{01022\ \ \ status\ =}
\DoxyCodeLine{01023\ \ \ \ \ \ \ zx::socket::create(0,\ \&stderr\_producer\_socket,\ \&stderr\_socket\_);}
\DoxyCodeLine{01024\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\ >=\ 0);}
\DoxyCodeLine{01025\ \ \ \textcolor{keywordtype}{int}\ stderr\_producer\_fd\ =\ -\/1;}
\DoxyCodeLine{01026\ \ \ status\ =}
\DoxyCodeLine{01027\ \ \ \ \ \ \ fdio\_fd\_create(stderr\_producer\_socket.release(),\ \&stderr\_producer\_fd);}
\DoxyCodeLine{01028\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\ >=\ 0);}
\DoxyCodeLine{01029\ }
\DoxyCodeLine{01030\ \ \ \textcolor{comment}{//\ Make\ the\ stderr\ socket\ nonblocking.}}
\DoxyCodeLine{01031\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(fcntl(stderr\_producer\_fd,\ F\_SETFL,\ 0)\ ==\ 0);}
\DoxyCodeLine{01032\ }
\DoxyCodeLine{01033\ \ \ fdio\_spawn\_action\_t*\ add\_stderr\_action\ =\ \&spawn\_actions[1];}
\DoxyCodeLine{01034\ \ \ add\_stderr\_action-\/>action\ =\ FDIO\_SPAWN\_ACTION\_CLONE\_FD;}
\DoxyCodeLine{01035\ \ \ add\_stderr\_action-\/>fd.local\_fd\ =\ stderr\_producer\_fd;}
\DoxyCodeLine{01036\ \ \ add\_stderr\_action-\/>fd.target\_fd\ =\ STDERR\_FILENO;}
\DoxyCodeLine{01037\ }
\DoxyCodeLine{01038\ \ \ \textcolor{comment}{//\ Create\ a\ child\ job.}}
\DoxyCodeLine{01039\ \ \ zx\_handle\_t\ child\_job\ =\ ZX\_HANDLE\_INVALID;}
\DoxyCodeLine{01040\ \ \ status\ =\ zx\_job\_create(zx\_job\_default(),\ 0,\ \&\ child\_job);}
\DoxyCodeLine{01041\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\ ==\ ZX\_OK);}
\DoxyCodeLine{01042\ \ \ zx\_policy\_basic\_t\ policy;}
\DoxyCodeLine{01043\ \ \ policy.condition\ =\ ZX\_POL\_NEW\_ANY;}
\DoxyCodeLine{01044\ \ \ policy.policy\ =\ ZX\_POL\_ACTION\_ALLOW;}
\DoxyCodeLine{01045\ \ \ status\ =\ zx\_job\_set\_policy(}
\DoxyCodeLine{01046\ \ \ \ \ \ \ child\_job,\ ZX\_JOB\_POL\_RELATIVE,\ ZX\_JOB\_POL\_BASIC,\ \&policy,\ 1);}
\DoxyCodeLine{01047\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\ ==\ ZX\_OK);}
\DoxyCodeLine{01048\ }
\DoxyCodeLine{01049\ \ \ \textcolor{comment}{//\ Create\ an\ exception\ channel\ attached\ to\ the\ |child\_job|,\ to\ allow}}
\DoxyCodeLine{01050\ \ \ \textcolor{comment}{//\ us\ to\ suppress\ the\ system\ default\ exception\ handler\ from\ firing.}}
\DoxyCodeLine{01051\ \ \ status\ =}
\DoxyCodeLine{01052\ \ \ \ \ \ \ zx\_task\_create\_exception\_channel(}
\DoxyCodeLine{01053\ \ \ \ \ \ \ \ \ \ \ child\_job,\ 0,\ exception\_channel\_.reset\_and\_get\_address());}
\DoxyCodeLine{01054\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\ ==\ ZX\_OK);}
\DoxyCodeLine{01055\ }
\DoxyCodeLine{01056\ \ \ \textcolor{comment}{//\ Spawn\ the\ child\ process.}}
\DoxyCodeLine{01057\ \ \ status\ =\ fdio\_spawn\_etc(}
\DoxyCodeLine{01058\ \ \ \ \ \ \ child\_job,\ FDIO\_SPAWN\_CLONE\_ALL,\ args.Argv()[0],\ args.Argv(),\ \textcolor{keyword}{nullptr},}
\DoxyCodeLine{01059\ \ \ \ \ \ \ 2,\ spawn\_actions,\ child\_process\_.reset\_and\_get\_address(),\ \textcolor{keyword}{nullptr});}
\DoxyCodeLine{01060\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(status\ ==\ ZX\_OK);}
\DoxyCodeLine{01061\ }
\DoxyCodeLine{01062\ \ \ set\_spawned(\textcolor{keyword}{true});}
\DoxyCodeLine{01063\ \ \ \textcolor{keywordflow}{return}\ OVERSEE\_TEST;}
\DoxyCodeLine{01064\ \}}
\DoxyCodeLine{01065\ }
\DoxyCodeLine{01066\ std::string\ FuchsiaDeathTest::GetErrorLogs()\ \{}
\DoxyCodeLine{01067\ \ \ \textcolor{keywordflow}{return}\ captured\_stderr\_;}
\DoxyCodeLine{01068\ \}}
\DoxyCodeLine{01069\ }
\DoxyCodeLine{01070\ \textcolor{preprocessor}{\#else\ \ }\textcolor{comment}{//\ We\ are\ neither\ on\ Windows,\ nor\ on\ Fuchsia.}}
\DoxyCodeLine{01071\ }
\DoxyCodeLine{01072\ \textcolor{comment}{//\ ForkingDeathTest\ provides\ implementations\ for\ most\ of\ the\ abstract}}
\DoxyCodeLine{01073\ \textcolor{comment}{//\ methods\ of\ the\ DeathTest\ interface.\ \ Only\ the\ AssumeRole\ method\ is}}
\DoxyCodeLine{01074\ \textcolor{comment}{//\ left\ undefined.}}
\DoxyCodeLine{01075\ \textcolor{keyword}{class\ }ForkingDeathTest\ :\ \textcolor{keyword}{public}\ DeathTestImpl\ \{}
\DoxyCodeLine{01076\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{01077\ \ \ ForkingDeathTest(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ statement,\ Matcher<const\ std::string\&>\ matcher);}
\DoxyCodeLine{01078\ }
\DoxyCodeLine{01079\ \ \ \textcolor{comment}{//\ All\ of\ these\ virtual\ functions\ are\ inherited\ from\ DeathTest.}}
\DoxyCodeLine{01080\ \ \ \textcolor{keywordtype}{int}\ Wait()\ \textcolor{keyword}{override};}
\DoxyCodeLine{01081\ }
\DoxyCodeLine{01082\ \ \textcolor{keyword}{protected}:}
\DoxyCodeLine{01083\ \ \ \textcolor{keywordtype}{void}\ set\_child\_pid(pid\_t\ child\_pid)\ \{\ child\_pid\_\ =\ child\_pid;\ \}}
\DoxyCodeLine{01084\ }
\DoxyCodeLine{01085\ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{01086\ \ \ \textcolor{comment}{//\ PID\ of\ child\ process\ during\ death\ test;\ 0\ in\ the\ child\ process\ itself.}}
\DoxyCodeLine{01087\ \ \ pid\_t\ child\_pid\_;}
\DoxyCodeLine{01088\ \};}
\DoxyCodeLine{01089\ }
\DoxyCodeLine{01090\ \textcolor{comment}{//\ Constructs\ a\ ForkingDeathTest.}}
\DoxyCodeLine{01091\ ForkingDeathTest::ForkingDeathTest(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ a\_statement,}
\DoxyCodeLine{01092\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Matcher<const\ std::string\&>\ matcher)}
\DoxyCodeLine{01093\ \ \ \ \ :\ DeathTestImpl(a\_statement,\ std::move(matcher)),\ child\_pid\_(-\/1)\ \{\}}
\DoxyCodeLine{01094\ }
\DoxyCodeLine{01095\ \textcolor{comment}{//\ Waits\ for\ the\ child\ in\ a\ death\ test\ to\ exit,\ returning\ its\ exit}}
\DoxyCodeLine{01096\ \textcolor{comment}{//\ status,\ or\ 0\ if\ no\ child\ process\ exists.\ \ As\ a\ side\ effect,\ sets\ the}}
\DoxyCodeLine{01097\ \textcolor{comment}{//\ outcome\ data\ member.}}
\DoxyCodeLine{01098\ \textcolor{keywordtype}{int}\ ForkingDeathTest::Wait()\ \{}
\DoxyCodeLine{01099\ \ \ \textcolor{keywordflow}{if}\ (!spawned())}
\DoxyCodeLine{01100\ \ \ \ \ \textcolor{keywordflow}{return}\ 0;}
\DoxyCodeLine{01101\ }
\DoxyCodeLine{01102\ \ \ ReadAndInterpretStatusByte();}
\DoxyCodeLine{01103\ }
\DoxyCodeLine{01104\ \ \ \textcolor{keywordtype}{int}\ status\_value;}
\DoxyCodeLine{01105\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(waitpid(child\_pid\_,\ \&status\_value,\ 0));}
\DoxyCodeLine{01106\ \ \ set\_status(status\_value);}
\DoxyCodeLine{01107\ \ \ \textcolor{keywordflow}{return}\ status\_value;}
\DoxyCodeLine{01108\ \}}
\DoxyCodeLine{01109\ }
\DoxyCodeLine{01110\ \textcolor{comment}{//\ A\ concrete\ death\ test\ class\ that\ forks,\ then\ immediately\ runs\ the\ test}}
\DoxyCodeLine{01111\ \textcolor{comment}{//\ in\ the\ child\ process.}}
\DoxyCodeLine{01112\ \textcolor{keyword}{class\ }NoExecDeathTest\ :\ \textcolor{keyword}{public}\ ForkingDeathTest\ \{}
\DoxyCodeLine{01113\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{01114\ \ \ NoExecDeathTest(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ a\_statement,\ Matcher<const\ std::string\&>\ matcher)}
\DoxyCodeLine{01115\ \ \ \ \ \ \ :\ ForkingDeathTest(a\_statement,\ std::move(matcher))\ \{\}}
\DoxyCodeLine{01116\ \ \ TestRole\ AssumeRole()\ \textcolor{keyword}{override};}
\DoxyCodeLine{01117\ \};}
\DoxyCodeLine{01118\ }
\DoxyCodeLine{01119\ \textcolor{comment}{//\ The\ AssumeRole\ process\ for\ a\ fork-\/and-\/run\ death\ test.\ \ It\ implements\ a}}
\DoxyCodeLine{01120\ \textcolor{comment}{//\ straightforward\ fork,\ with\ a\ simple\ pipe\ to\ transmit\ the\ status\ byte.}}
\DoxyCodeLine{01121\ DeathTest::TestRole\ NoExecDeathTest::AssumeRole()\ \{}
\DoxyCodeLine{01122\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ thread\_count\ =\ GetThreadCount();}
\DoxyCodeLine{01123\ \ \ \textcolor{keywordflow}{if}\ (thread\_count\ !=\ 1)\ \{}
\DoxyCodeLine{01124\ \ \ \ \ GTEST\_LOG\_(WARNING)\ <<\ DeathTestThreadWarning(thread\_count);}
\DoxyCodeLine{01125\ \ \ \}}
\DoxyCodeLine{01126\ }
\DoxyCodeLine{01127\ \ \ \textcolor{keywordtype}{int}\ pipe\_fd[2];}
\DoxyCodeLine{01128\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(pipe(pipe\_fd)\ !=\ -\/1);}
\DoxyCodeLine{01129\ }
\DoxyCodeLine{01130\ \ \ DeathTest::set\_last\_death\_test\_message(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{01131\ \ \ CaptureStderr();}
\DoxyCodeLine{01132\ \ \ \textcolor{comment}{//\ When\ we\ fork\ the\ process\ below,\ the\ log\ file\ buffers\ are\ copied,\ but\ the}}
\DoxyCodeLine{01133\ \ \ \textcolor{comment}{//\ file\ descriptors\ are\ shared.\ \ We\ flush\ all\ log\ files\ here\ so\ that\ closing}}
\DoxyCodeLine{01134\ \ \ \textcolor{comment}{//\ the\ file\ descriptors\ in\ the\ child\ process\ doesn't\ throw\ off\ the}}
\DoxyCodeLine{01135\ \ \ \textcolor{comment}{//\ synchronization\ between\ descriptors\ and\ buffers\ in\ the\ parent\ process.}}
\DoxyCodeLine{01136\ \ \ \textcolor{comment}{//\ This\ is\ as\ close\ to\ the\ fork\ as\ possible\ to\ avoid\ a\ race\ condition\ in\ case}}
\DoxyCodeLine{01137\ \ \ \textcolor{comment}{//\ there\ are\ multiple\ threads\ running\ before\ the\ death\ test,\ and\ another}}
\DoxyCodeLine{01138\ \ \ \textcolor{comment}{//\ thread\ writes\ to\ the\ log\ file.}}
\DoxyCodeLine{01139\ \ \ FlushInfoLog();}
\DoxyCodeLine{01140\ }
\DoxyCodeLine{01141\ \ \ \textcolor{keyword}{const}\ pid\_t\ child\_pid\ =\ fork();}
\DoxyCodeLine{01142\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(child\_pid\ !=\ -\/1);}
\DoxyCodeLine{01143\ \ \ set\_child\_pid(child\_pid);}
\DoxyCodeLine{01144\ \ \ \textcolor{keywordflow}{if}\ (child\_pid\ ==\ 0)\ \{}
\DoxyCodeLine{01145\ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(close(pipe\_fd[0]));}
\DoxyCodeLine{01146\ \ \ \ \ set\_write\_fd(pipe\_fd[1]);}
\DoxyCodeLine{01147\ \ \ \ \ \textcolor{comment}{//\ Redirects\ all\ logging\ to\ stderr\ in\ the\ child\ process\ to\ prevent}}
\DoxyCodeLine{01148\ \ \ \ \ \textcolor{comment}{//\ concurrent\ writes\ to\ the\ log\ files.\ \ We\ capture\ stderr\ in\ the\ parent}}
\DoxyCodeLine{01149\ \ \ \ \ \textcolor{comment}{//\ process\ and\ append\ the\ child\ process'\ output\ to\ a\ log.}}
\DoxyCodeLine{01150\ \ \ \ \ LogToStderr();}
\DoxyCodeLine{01151\ \ \ \ \ \textcolor{comment}{//\ Event\ forwarding\ to\ the\ listeners\ of\ event\ listener\ API\ mush\ be\ shut}}
\DoxyCodeLine{01152\ \ \ \ \ \textcolor{comment}{//\ down\ in\ death\ test\ subprocesses.}}
\DoxyCodeLine{01153\ \ \ \ \ GetUnitTestImpl()-\/>listeners()-\/>SuppressEventForwarding();}
\DoxyCodeLine{01154\ \ \ \ \ g\_in\_fast\_death\_test\_child\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01155\ \ \ \ \ \textcolor{keywordflow}{return}\ EXECUTE\_TEST;}
\DoxyCodeLine{01156\ \ \ \}\ \textcolor{keywordflow}{else}\ \{}
\DoxyCodeLine{01157\ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(close(pipe\_fd[1]));}
\DoxyCodeLine{01158\ \ \ \ \ set\_read\_fd(pipe\_fd[0]);}
\DoxyCodeLine{01159\ \ \ \ \ set\_spawned(\textcolor{keyword}{true});}
\DoxyCodeLine{01160\ \ \ \ \ \textcolor{keywordflow}{return}\ OVERSEE\_TEST;}
\DoxyCodeLine{01161\ \ \ \}}
\DoxyCodeLine{01162\ \}}
\DoxyCodeLine{01163\ }
\DoxyCodeLine{01164\ \textcolor{comment}{//\ A\ concrete\ death\ test\ class\ that\ forks\ and\ re-\/executes\ the\ main}}
\DoxyCodeLine{01165\ \textcolor{comment}{//\ program\ from\ the\ beginning,\ with\ command-\/line\ flags\ set\ that\ cause}}
\DoxyCodeLine{01166\ \textcolor{comment}{//\ only\ this\ specific\ death\ test\ to\ be\ run.}}
\DoxyCodeLine{01167\ \textcolor{keyword}{class\ }ExecDeathTest\ :\ \textcolor{keyword}{public}\ ForkingDeathTest\ \{}
\DoxyCodeLine{01168\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{01169\ \ \ ExecDeathTest(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ a\_statement,\ Matcher<const\ std::string\&>\ matcher,}
\DoxyCodeLine{01170\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ file,\ \textcolor{keywordtype}{int}\ line)}
\DoxyCodeLine{01171\ \ \ \ \ \ \ :\ ForkingDeathTest(a\_statement,\ std::move(matcher)),}
\DoxyCodeLine{01172\ \ \ \ \ \ \ \ \ file\_(file),}
\DoxyCodeLine{01173\ \ \ \ \ \ \ \ \ line\_(line)\ \{\}}
\DoxyCodeLine{01174\ \ \ TestRole\ AssumeRole()\ \textcolor{keyword}{override};}
\DoxyCodeLine{01175\ }
\DoxyCodeLine{01176\ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{01177\ \ \ static\ ::std::vector<std::string>\ GetArgvsForDeathTestChildProcess()\ \{}
\DoxyCodeLine{01178\ \ \ \ \ ::std::vector<std::string>\ args\ =\ GetInjectableArgvs();}
\DoxyCodeLine{01179\ \textcolor{preprocessor}{\#\ \ if\ defined(GTEST\_EXTRA\_DEATH\_TEST\_COMMAND\_LINE\_ARGS\_)}}
\DoxyCodeLine{01180\ \ \ \ \ ::std::vector<std::string>\ extra\_args\ =}
\DoxyCodeLine{01181\ \ \ \ \ \ \ \ \ GTEST\_EXTRA\_DEATH\_TEST\_COMMAND\_LINE\_ARGS\_();}
\DoxyCodeLine{01182\ \ \ \ \ args.insert(args.end(),\ extra\_args.begin(),\ extra\_args.end());}
\DoxyCodeLine{01183\ \textcolor{preprocessor}{\#\ \ endif\ \ }\textcolor{comment}{//\ defined(GTEST\_EXTRA\_DEATH\_TEST\_COMMAND\_LINE\_ARGS\_)}}
\DoxyCodeLine{01184\ \ \ \ \ \textcolor{keywordflow}{return}\ args;}
\DoxyCodeLine{01185\ \ \ \}}
\DoxyCodeLine{01186\ \ \ \textcolor{comment}{//\ The\ name\ of\ the\ file\ in\ which\ the\ death\ test\ is\ located.}}
\DoxyCodeLine{01187\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}\ file\_;}
\DoxyCodeLine{01188\ \ \ \textcolor{comment}{//\ The\ line\ number\ on\ which\ the\ death\ test\ is\ located.}}
\DoxyCodeLine{01189\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ line\_;}
\DoxyCodeLine{01190\ \};}
\DoxyCodeLine{01191\ }
\DoxyCodeLine{01192\ \textcolor{comment}{//\ Utility\ class\ for\ accumulating\ command-\/line\ arguments.}}
\DoxyCodeLine{01193\ \textcolor{keyword}{class\ }Arguments\ \{}
\DoxyCodeLine{01194\ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{01195\ \ \ Arguments()\ \{\ args\_.push\_back(\textcolor{keyword}{nullptr});\ \}}
\DoxyCodeLine{01196\ }
\DoxyCodeLine{01197\ \ \ \string~Arguments()\ \{}
\DoxyCodeLine{01198\ \ \ \ \ \textcolor{keywordflow}{for}\ (std::vector<char*>::iterator\ i\ =\ args\_.begin();\ i\ !=\ args\_.end();}
\DoxyCodeLine{01199\ \ \ \ \ \ \ \ \ \ ++i)\ \{}
\DoxyCodeLine{01200\ \ \ \ \ \ \ free(*i);}
\DoxyCodeLine{01201\ \ \ \ \ \}}
\DoxyCodeLine{01202\ \ \ \}}
\DoxyCodeLine{01203\ \ \ \textcolor{keywordtype}{void}\ AddArgument(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ argument)\ \{}
\DoxyCodeLine{01204\ \ \ \ \ args\_.insert(args\_.end()\ -\/\ 1,\ posix::StrDup(argument));}
\DoxyCodeLine{01205\ \ \ \}}
\DoxyCodeLine{01206\ }
\DoxyCodeLine{01207\ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Str>}
\DoxyCodeLine{01208\ \ \ \textcolor{keywordtype}{void}\ AddArguments(const\ ::std::vector<Str>\&\ arguments)\ \{}
\DoxyCodeLine{01209\ \ \ \ \ \textcolor{keywordflow}{for}\ (typename\ ::std::vector<Str>::const\_iterator\ i\ =\ arguments.begin();}
\DoxyCodeLine{01210\ \ \ \ \ \ \ \ \ \ i\ !=\ arguments.end();}
\DoxyCodeLine{01211\ \ \ \ \ \ \ \ \ \ ++i)\ \{}
\DoxyCodeLine{01212\ \ \ \ \ \ \ args\_.insert(args\_.end()\ -\/\ 1,\ posix::StrDup(i-\/>c\_str()));}
\DoxyCodeLine{01213\ \ \ \ \ \}}
\DoxyCodeLine{01214\ \ \ \}}
\DoxyCodeLine{01215\ \ \ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}*\ Argv()\ \{}
\DoxyCodeLine{01216\ \ \ \ \ \textcolor{keywordflow}{return}\ \&args\_[0];}
\DoxyCodeLine{01217\ \ \ \}}
\DoxyCodeLine{01218\ }
\DoxyCodeLine{01219\ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{01220\ \ \ std::vector<char*>\ args\_;}
\DoxyCodeLine{01221\ \};}
\DoxyCodeLine{01222\ }
\DoxyCodeLine{01223\ \textcolor{comment}{//\ A\ struct\ that\ encompasses\ the\ arguments\ to\ the\ child\ process\ of\ a}}
\DoxyCodeLine{01224\ \textcolor{comment}{//\ threadsafe-\/style\ death\ test\ process.}}
\DoxyCodeLine{01225\ \textcolor{keyword}{struct\ }ExecDeathTestArgs\ \{}
\DoxyCodeLine{01226\ \ \ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}*\ argv;\ \ \textcolor{comment}{//\ Command-\/line\ arguments\ for\ the\ child's\ call\ to\ exec}}
\DoxyCodeLine{01227\ \ \ \textcolor{keywordtype}{int}\ close\_fd;\ \ \ \ \ \ \ \textcolor{comment}{//\ File\ descriptor\ to\ close;\ the\ read\ end\ of\ a\ pipe}}
\DoxyCodeLine{01228\ \};}
\DoxyCodeLine{01229\ }
\DoxyCodeLine{01230\ \textcolor{preprocessor}{\#\ \ if\ GTEST\_OS\_QNX}}
\DoxyCodeLine{01231\ \textcolor{keyword}{extern}\ \textcolor{stringliteral}{"{}C"{}}\ \textcolor{keywordtype}{char}**\ environ;}
\DoxyCodeLine{01232\ \textcolor{preprocessor}{\#\ \ else\ \ }\textcolor{comment}{//\ GTEST\_OS\_QNX}}
\DoxyCodeLine{01233\ \textcolor{comment}{//\ The\ main\ function\ for\ a\ threadsafe-\/style\ death\ test\ child\ process.}}
\DoxyCodeLine{01234\ \textcolor{comment}{//\ This\ function\ is\ called\ in\ a\ clone()-\/ed\ process\ and\ thus\ must\ avoid}}
\DoxyCodeLine{01235\ \textcolor{comment}{//\ any\ potentially\ unsafe\ operations\ like\ malloc\ or\ libc\ functions.}}
\DoxyCodeLine{01236\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ ExecDeathTestChildMain(\textcolor{keywordtype}{void}*\ child\_arg)\ \{}
\DoxyCodeLine{01237\ \ \ ExecDeathTestArgs*\ \textcolor{keyword}{const}\ args\ =\ \textcolor{keyword}{static\_cast<}ExecDeathTestArgs*\textcolor{keyword}{>}(child\_arg);}
\DoxyCodeLine{01238\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(close(args-\/>close\_fd));}
\DoxyCodeLine{01239\ }
\DoxyCodeLine{01240\ \ \ \textcolor{comment}{//\ We\ need\ to\ execute\ the\ test\ program\ in\ the\ same\ environment\ where}}
\DoxyCodeLine{01241\ \ \ \textcolor{comment}{//\ it\ was\ originally\ invoked.\ \ Therefore\ we\ change\ to\ the\ original}}
\DoxyCodeLine{01242\ \ \ \textcolor{comment}{//\ working\ directory\ first.}}
\DoxyCodeLine{01243\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}\ original\_dir\ =}
\DoxyCodeLine{01244\ \ \ \ \ \ \ UnitTest::GetInstance()-\/>original\_working\_dir();}
\DoxyCodeLine{01245\ \ \ \textcolor{comment}{//\ We\ can\ safely\ call\ chdir()\ as\ it's\ a\ direct\ system\ call.}}
\DoxyCodeLine{01246\ \ \ \textcolor{keywordflow}{if}\ (chdir(original\_dir)\ !=\ 0)\ \{}
\DoxyCodeLine{01247\ \ \ \ \ DeathTestAbort(std::string(\textcolor{stringliteral}{"{}chdir(\(\backslash\)"{}"{}})\ +\ original\_dir\ +\ \textcolor{stringliteral}{"{}\(\backslash\)"{})\ failed:\ "{}}\ +}
\DoxyCodeLine{01248\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GetLastErrnoDescription());}
\DoxyCodeLine{01249\ \ \ \ \ \textcolor{keywordflow}{return}\ EXIT\_FAILURE;}
\DoxyCodeLine{01250\ \ \ \}}
\DoxyCodeLine{01251\ }
\DoxyCodeLine{01252\ \ \ \textcolor{comment}{//\ We\ can\ safely\ call\ execv()\ as\ it's\ almost\ a\ direct\ system\ call.\ We}}
\DoxyCodeLine{01253\ \ \ \textcolor{comment}{//\ cannot\ use\ execvp()\ as\ it's\ a\ libc\ function\ and\ thus\ potentially}}
\DoxyCodeLine{01254\ \ \ \textcolor{comment}{//\ unsafe.\ \ Since\ execv()\ doesn't\ search\ the\ PATH,\ the\ user\ must}}
\DoxyCodeLine{01255\ \ \ \textcolor{comment}{//\ invoke\ the\ test\ program\ via\ a\ valid\ path\ that\ contains\ at\ least}}
\DoxyCodeLine{01256\ \ \ \textcolor{comment}{//\ one\ path\ separator.}}
\DoxyCodeLine{01257\ \ \ execv(args-\/>argv[0],\ args-\/>argv);}
\DoxyCodeLine{01258\ \ \ DeathTestAbort(std::string(\textcolor{stringliteral}{"{}execv("{}})\ +\ args-\/>argv[0]\ +\ \textcolor{stringliteral}{"{},\ ...)\ in\ "{}}\ +}
\DoxyCodeLine{01259\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ original\_dir\ +\ \textcolor{stringliteral}{"{}\ failed:\ "{}}\ +}
\DoxyCodeLine{01260\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GetLastErrnoDescription());}
\DoxyCodeLine{01261\ \ \ \textcolor{keywordflow}{return}\ EXIT\_FAILURE;}
\DoxyCodeLine{01262\ \}}
\DoxyCodeLine{01263\ \textcolor{preprocessor}{\#\ \ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_QNX}}
\DoxyCodeLine{01264\ }
\DoxyCodeLine{01265\ \textcolor{preprocessor}{\#\ \ if\ GTEST\_HAS\_CLONE}}
\DoxyCodeLine{01266\ \textcolor{comment}{//\ Two\ utility\ routines\ that\ together\ determine\ the\ direction\ the\ stack}}
\DoxyCodeLine{01267\ \textcolor{comment}{//\ grows.}}
\DoxyCodeLine{01268\ \textcolor{comment}{//\ This\ could\ be\ accomplished\ more\ elegantly\ by\ a\ single\ recursive}}
\DoxyCodeLine{01269\ \textcolor{comment}{//\ function,\ but\ we\ want\ to\ guard\ against\ the\ unlikely\ possibility\ of}}
\DoxyCodeLine{01270\ \textcolor{comment}{//\ a\ smart\ compiler\ optimizing\ the\ recursion\ away.}}
\DoxyCodeLine{01271\ \textcolor{comment}{//}}
\DoxyCodeLine{01272\ \textcolor{comment}{//\ GTEST\_NO\_INLINE\_\ is\ required\ to\ prevent\ GCC\ 4.6\ from\ inlining}}
\DoxyCodeLine{01273\ \textcolor{comment}{//\ StackLowerThanAddress\ into\ StackGrowsDown,\ which\ then\ doesn't\ give}}
\DoxyCodeLine{01274\ \textcolor{comment}{//\ correct\ answer.}}
\DoxyCodeLine{01275\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ StackLowerThanAddress(\textcolor{keyword}{const}\ \textcolor{keywordtype}{void}*\ ptr,}
\DoxyCodeLine{01276\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{bool}*\ result)\ GTEST\_NO\_INLINE\_;}
\DoxyCodeLine{01277\ \textcolor{comment}{//\ Make\ sure\ sanitizers\ do\ not\ tamper\ with\ the\ stack\ here.}}
\DoxyCodeLine{01278\ \textcolor{comment}{//\ Ideally,\ we\ want\ to\ use\ \`{}\_\_builtin\_frame\_address`\ instead\ of\ a\ local\ variable}}
\DoxyCodeLine{01279\ \textcolor{comment}{//\ address\ with\ sanitizer\ disabled,\ but\ it\ does\ not\ work\ when\ the}}
\DoxyCodeLine{01280\ \textcolor{comment}{//\ compiler\ optimizes\ the\ stack\ frame\ out,\ which\ happens\ on\ PowerPC\ targets.}}
\DoxyCodeLine{01281\ \textcolor{comment}{//\ HWAddressSanitizer\ add\ a\ random\ tag\ to\ the\ MSB\ of\ the\ local\ variable\ address,}}
\DoxyCodeLine{01282\ \textcolor{comment}{//\ making\ comparison\ result\ unpredictable.}}
\DoxyCodeLine{01283\ GTEST\_ATTRIBUTE\_NO\_SANITIZE\_ADDRESS\_}
\DoxyCodeLine{01284\ GTEST\_ATTRIBUTE\_NO\_SANITIZE\_HWADDRESS\_}
\DoxyCodeLine{01285\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{void}\ StackLowerThanAddress(\textcolor{keyword}{const}\ \textcolor{keywordtype}{void}*\ ptr,\ \textcolor{keywordtype}{bool}*\ result)\ \{}
\DoxyCodeLine{01286\ \ \ \textcolor{keywordtype}{int}\ dummy\ =\ 0;}
\DoxyCodeLine{01287\ \ \ *result\ =\ std::less<const\ void*>()(\&dummy,\ ptr);}
\DoxyCodeLine{01288\ \}}
\DoxyCodeLine{01289\ }
\DoxyCodeLine{01290\ \textcolor{comment}{//\ Make\ sure\ AddressSanitizer\ does\ not\ tamper\ with\ the\ stack\ here.}}
\DoxyCodeLine{01291\ GTEST\_ATTRIBUTE\_NO\_SANITIZE\_ADDRESS\_}
\DoxyCodeLine{01292\ GTEST\_ATTRIBUTE\_NO\_SANITIZE\_HWADDRESS\_}
\DoxyCodeLine{01293\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{bool}\ StackGrowsDown()\ \{}
\DoxyCodeLine{01294\ \ \ \textcolor{keywordtype}{int}\ dummy\ =\ 0;}
\DoxyCodeLine{01295\ \ \ \textcolor{keywordtype}{bool}\ result;}
\DoxyCodeLine{01296\ \ \ StackLowerThanAddress(\&dummy,\ \&result);}
\DoxyCodeLine{01297\ \ \ \textcolor{keywordflow}{return}\ result;}
\DoxyCodeLine{01298\ \}}
\DoxyCodeLine{01299\ \textcolor{preprocessor}{\#\ \ endif\ \ }\textcolor{comment}{//\ GTEST\_HAS\_CLONE}}
\DoxyCodeLine{01300\ }
\DoxyCodeLine{01301\ \textcolor{comment}{//\ Spawns\ a\ child\ process\ with\ the\ same\ executable\ as\ the\ current\ process\ in}}
\DoxyCodeLine{01302\ \textcolor{comment}{//\ a\ thread-\/safe\ manner\ and\ instructs\ it\ to\ run\ the\ death\ test.\ \ The}}
\DoxyCodeLine{01303\ \textcolor{comment}{//\ implementation\ uses\ fork(2)\ +\ exec.\ \ On\ systems\ where\ clone(2)\ is}}
\DoxyCodeLine{01304\ \textcolor{comment}{//\ available,\ it\ is\ used\ instead,\ being\ slightly\ more\ thread-\/safe.\ \ On\ QNX,}}
\DoxyCodeLine{01305\ \textcolor{comment}{//\ fork\ supports\ only\ single-\/threaded\ environments,\ so\ this\ function\ uses}}
\DoxyCodeLine{01306\ \textcolor{comment}{//\ spawn(2)\ there\ instead.\ \ The\ function\ dies\ with\ an\ error\ message\ if}}
\DoxyCodeLine{01307\ \textcolor{comment}{//\ anything\ goes\ wrong.}}
\DoxyCodeLine{01308\ \textcolor{keyword}{static}\ pid\_t\ ExecDeathTestSpawnChild(\textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}*\ argv,\ \textcolor{keywordtype}{int}\ close\_fd)\ \{}
\DoxyCodeLine{01309\ \ \ ExecDeathTestArgs\ args\ =\ \{\ argv,\ close\_fd\ \};}
\DoxyCodeLine{01310\ \ \ pid\_t\ child\_pid\ =\ -\/1;}
\DoxyCodeLine{01311\ }
\DoxyCodeLine{01312\ \textcolor{preprocessor}{\#\ \ if\ GTEST\_OS\_QNX}}
\DoxyCodeLine{01313\ \ \ \textcolor{comment}{//\ Obtains\ the\ current\ directory\ and\ sets\ it\ to\ be\ closed\ in\ the\ child}}
\DoxyCodeLine{01314\ \ \ \textcolor{comment}{//\ process.}}
\DoxyCodeLine{01315\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ cwd\_fd\ =\ open(\textcolor{stringliteral}{"{}."{}},\ O\_RDONLY);}
\DoxyCodeLine{01316\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(cwd\_fd\ !=\ -\/1);}
\DoxyCodeLine{01317\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(fcntl(cwd\_fd,\ F\_SETFD,\ FD\_CLOEXEC));}
\DoxyCodeLine{01318\ \ \ \textcolor{comment}{//\ We\ need\ to\ execute\ the\ test\ program\ in\ the\ same\ environment\ where}}
\DoxyCodeLine{01319\ \ \ \textcolor{comment}{//\ it\ was\ originally\ invoked.\ \ Therefore\ we\ change\ to\ the\ original}}
\DoxyCodeLine{01320\ \ \ \textcolor{comment}{//\ working\ directory\ first.}}
\DoxyCodeLine{01321\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ \textcolor{keyword}{const}\ original\_dir\ =}
\DoxyCodeLine{01322\ \ \ \ \ \ \ UnitTest::GetInstance()-\/>original\_working\_dir();}
\DoxyCodeLine{01323\ \ \ \textcolor{comment}{//\ We\ can\ safely\ call\ chdir()\ as\ it's\ a\ direct\ system\ call.}}
\DoxyCodeLine{01324\ \ \ \textcolor{keywordflow}{if}\ (chdir(original\_dir)\ !=\ 0)\ \{}
\DoxyCodeLine{01325\ \ \ \ \ DeathTestAbort(std::string(\textcolor{stringliteral}{"{}chdir(\(\backslash\)"{}"{}})\ +\ original\_dir\ +\ \textcolor{stringliteral}{"{}\(\backslash\)"{})\ failed:\ "{}}\ +}
\DoxyCodeLine{01326\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GetLastErrnoDescription());}
\DoxyCodeLine{01327\ \ \ \ \ \textcolor{keywordflow}{return}\ EXIT\_FAILURE;}
\DoxyCodeLine{01328\ \ \ \}}
\DoxyCodeLine{01329\ }
\DoxyCodeLine{01330\ \ \ \textcolor{keywordtype}{int}\ fd\_flags;}
\DoxyCodeLine{01331\ \ \ \textcolor{comment}{//\ Set\ close\_fd\ to\ be\ closed\ after\ spawn.}}
\DoxyCodeLine{01332\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(fd\_flags\ =\ fcntl(close\_fd,\ F\_GETFD));}
\DoxyCodeLine{01333\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(fcntl(close\_fd,\ F\_SETFD,}
\DoxyCodeLine{01334\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ fd\_flags\ |\ FD\_CLOEXEC));}
\DoxyCodeLine{01335\ \ \ \textcolor{keyword}{struct\ }inheritance\ inherit\ =\ \{0\};}
\DoxyCodeLine{01336\ \ \ \textcolor{comment}{//\ spawn\ is\ a\ system\ call.}}
\DoxyCodeLine{01337\ \ \ child\_pid\ =\ spawn(args.argv[0],\ 0,\ \textcolor{keyword}{nullptr},\ \&inherit,\ args.argv,\ environ);}
\DoxyCodeLine{01338\ \ \ \textcolor{comment}{//\ Restores\ the\ current\ working\ directory.}}
\DoxyCodeLine{01339\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(fchdir(cwd\_fd)\ !=\ -\/1);}
\DoxyCodeLine{01340\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(close(cwd\_fd));}
\DoxyCodeLine{01341\ }
\DoxyCodeLine{01342\ \textcolor{preprocessor}{\#\ \ else\ \ \ }\textcolor{comment}{//\ GTEST\_OS\_QNX}}
\DoxyCodeLine{01343\ \textcolor{preprocessor}{\#\ \ \ if\ GTEST\_OS\_LINUX}}
\DoxyCodeLine{01344\ \ \ \textcolor{comment}{//\ When\ a\ SIGPROF\ signal\ is\ received\ while\ fork()\ or\ clone()\ are\ executing,}}
\DoxyCodeLine{01345\ \ \ \textcolor{comment}{//\ the\ process\ may\ hang.\ To\ avoid\ this,\ we\ ignore\ SIGPROF\ here\ and\ re-\/enable}}
\DoxyCodeLine{01346\ \ \ \textcolor{comment}{//\ it\ after\ the\ call\ to\ fork()/clone()\ is\ complete.}}
\DoxyCodeLine{01347\ \ \ \textcolor{keyword}{struct\ }sigaction\ saved\_sigprof\_action;}
\DoxyCodeLine{01348\ \ \ \textcolor{keyword}{struct\ }sigaction\ ignore\_sigprof\_action;}
\DoxyCodeLine{01349\ \ \ memset(\&ignore\_sigprof\_action,\ 0,\ \textcolor{keyword}{sizeof}(ignore\_sigprof\_action));}
\DoxyCodeLine{01350\ \ \ sigemptyset(\&ignore\_sigprof\_action.sa\_mask);}
\DoxyCodeLine{01351\ \ \ ignore\_sigprof\_action.sa\_handler\ =\ SIG\_IGN;}
\DoxyCodeLine{01352\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(sigaction(}
\DoxyCodeLine{01353\ \ \ \ \ \ \ SIGPROF,\ \&ignore\_sigprof\_action,\ \&saved\_sigprof\_action));}
\DoxyCodeLine{01354\ \textcolor{preprocessor}{\#\ \ \ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_LINUX}}
\DoxyCodeLine{01355\ }
\DoxyCodeLine{01356\ \textcolor{preprocessor}{\#\ \ \ if\ GTEST\_HAS\_CLONE}}
\DoxyCodeLine{01357\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ use\_fork\ =\ GTEST\_FLAG\_GET(death\_test\_use\_fork);}
\DoxyCodeLine{01358\ }
\DoxyCodeLine{01359\ \ \ \textcolor{keywordflow}{if}\ (!use\_fork)\ \{}
\DoxyCodeLine{01360\ \ \ \ \ \textcolor{keyword}{static}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ stack\_grows\_down\ =\ StackGrowsDown();}
\DoxyCodeLine{01361\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\ stack\_size\ =\ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{size\_t}\textcolor{keyword}{>}(getpagesize()\ *\ 2);}
\DoxyCodeLine{01362\ \ \ \ \ \textcolor{comment}{//\ MMAP\_ANONYMOUS\ is\ not\ defined\ on\ Mac,\ so\ we\ use\ MAP\_ANON\ instead.}}
\DoxyCodeLine{01363\ \ \ \ \ \textcolor{keywordtype}{void}*\ \textcolor{keyword}{const}\ stack\ =\ mmap(\textcolor{keyword}{nullptr},\ stack\_size,\ PROT\_READ\ |\ PROT\_WRITE,}
\DoxyCodeLine{01364\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ MAP\_ANON\ |\ MAP\_PRIVATE,\ -\/1,\ 0);}
\DoxyCodeLine{01365\ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(stack\ !=\ MAP\_FAILED);}
\DoxyCodeLine{01366\ }
\DoxyCodeLine{01367\ \ \ \ \ \textcolor{comment}{//\ Maximum\ stack\ alignment\ in\ bytes:\ \ For\ a\ downward-\/growing\ stack,\ this}}
\DoxyCodeLine{01368\ \ \ \ \ \textcolor{comment}{//\ amount\ is\ subtracted\ from\ size\ of\ the\ stack\ space\ to\ get\ an\ address}}
\DoxyCodeLine{01369\ \ \ \ \ \textcolor{comment}{//\ that\ is\ within\ the\ stack\ space\ and\ is\ aligned\ on\ all\ systems\ we\ care}}
\DoxyCodeLine{01370\ \ \ \ \ \textcolor{comment}{//\ about.\ \ As\ far\ as\ I\ know\ there\ is\ no\ ABI\ with\ stack\ alignment\ greater}}
\DoxyCodeLine{01371\ \ \ \ \ \textcolor{comment}{//\ than\ 64.\ \ We\ assume\ stack\ and\ stack\_size\ already\ have\ alignment\ of}}
\DoxyCodeLine{01372\ \ \ \ \ \textcolor{comment}{//\ kMaxStackAlignment.}}
\DoxyCodeLine{01373\ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{size\_t}\ kMaxStackAlignment\ =\ 64;}
\DoxyCodeLine{01374\ \ \ \ \ \textcolor{keywordtype}{void}*\ \textcolor{keyword}{const}\ stack\_top\ =}
\DoxyCodeLine{01375\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{char}*\textcolor{keyword}{>}(stack)\ +}
\DoxyCodeLine{01376\ \ \ \ \ \ \ \ \ \ \ \ \ (stack\_grows\_down\ ?\ stack\_size\ -\/\ kMaxStackAlignment\ :\ 0);}
\DoxyCodeLine{01377\ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(}
\DoxyCodeLine{01378\ \ \ \ \ \ \ \ \ \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{size\_t}\textcolor{keyword}{>}(stack\_size)\ >\ kMaxStackAlignment\ \&\&}
\DoxyCodeLine{01379\ \ \ \ \ \ \ \ \ \textcolor{keyword}{reinterpret\_cast<}uintptr\_t\textcolor{keyword}{>}(stack\_top)\ \%\ kMaxStackAlignment\ ==\ 0);}
\DoxyCodeLine{01380\ }
\DoxyCodeLine{01381\ \ \ \ \ child\_pid\ =\ clone(\&ExecDeathTestChildMain,\ stack\_top,\ SIGCHLD,\ \&args);}
\DoxyCodeLine{01382\ }
\DoxyCodeLine{01383\ \ \ \ \ GTEST\_DEATH\_TEST\_CHECK\_(munmap(stack,\ stack\_size)\ !=\ -\/1);}
\DoxyCodeLine{01384\ \ \ \}}
\DoxyCodeLine{01385\ \textcolor{preprocessor}{\#\ \ \ else}}
\DoxyCodeLine{01386\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{bool}\ use\_fork\ =\ \textcolor{keyword}{true};}
\DoxyCodeLine{01387\ \textcolor{preprocessor}{\#\ \ \ endif\ \ }\textcolor{comment}{//\ GTEST\_HAS\_CLONE}}
\DoxyCodeLine{01388\ }
\DoxyCodeLine{01389\ \ \ \textcolor{keywordflow}{if}\ (use\_fork\ \&\&\ (child\_pid\ =\ fork())\ ==\ 0)\ \{}
\DoxyCodeLine{01390\ \ \ \ \ \ \ ExecDeathTestChildMain(\&args);}
\DoxyCodeLine{01391\ \ \ \ \ \ \ \_exit(0);}
\DoxyCodeLine{01392\ \ \ \}}
\DoxyCodeLine{01393\ \textcolor{preprocessor}{\#\ \ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_QNX}}
\DoxyCodeLine{01394\ \textcolor{preprocessor}{\#\ \ if\ GTEST\_OS\_LINUX}}
\DoxyCodeLine{01395\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(}
\DoxyCodeLine{01396\ \ \ \ \ \ \ sigaction(SIGPROF,\ \&saved\_sigprof\_action,\ \textcolor{keyword}{nullptr}));}
\DoxyCodeLine{01397\ \textcolor{preprocessor}{\#\ \ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_LINUX}}
\DoxyCodeLine{01398\ }
\DoxyCodeLine{01399\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(child\_pid\ !=\ -\/1);}
\DoxyCodeLine{01400\ \ \ \textcolor{keywordflow}{return}\ child\_pid;}
\DoxyCodeLine{01401\ \}}
\DoxyCodeLine{01402\ }
\DoxyCodeLine{01403\ \textcolor{comment}{//\ The\ AssumeRole\ process\ for\ a\ fork-\/and-\/exec\ death\ test.\ \ It\ re-\/executes\ the}}
\DoxyCodeLine{01404\ \textcolor{comment}{//\ main\ program\ from\ the\ beginning,\ setting\ the\ -\/-\/gtest\_filter}}
\DoxyCodeLine{01405\ \textcolor{comment}{//\ and\ -\/-\/gtest\_internal\_run\_death\_test\ flags\ to\ cause\ only\ the\ current}}
\DoxyCodeLine{01406\ \textcolor{comment}{//\ death\ test\ to\ be\ re-\/run.}}
\DoxyCodeLine{01407\ DeathTest::TestRole\ ExecDeathTest::AssumeRole()\ \{}
\DoxyCodeLine{01408\ \ \ \textcolor{keyword}{const}\ UnitTestImpl*\ \textcolor{keyword}{const}\ impl\ =\ GetUnitTestImpl();}
\DoxyCodeLine{01409\ \ \ \textcolor{keyword}{const}\ InternalRunDeathTestFlag*\ \textcolor{keyword}{const}\ flag\ =}
\DoxyCodeLine{01410\ \ \ \ \ \ \ impl-\/>internal\_run\_death\_test\_flag();}
\DoxyCodeLine{01411\ \ \ \textcolor{keyword}{const}\ TestInfo*\ \textcolor{keyword}{const}\ info\ =\ impl-\/>current\_test\_info();}
\DoxyCodeLine{01412\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ death\_test\_index\ =\ info-\/>result()-\/>death\_test\_count();}
\DoxyCodeLine{01413\ }
\DoxyCodeLine{01414\ \ \ \textcolor{keywordflow}{if}\ (flag\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01415\ \ \ \ \ set\_write\_fd(flag-\/>write\_fd());}
\DoxyCodeLine{01416\ \ \ \ \ \textcolor{keywordflow}{return}\ EXECUTE\_TEST;}
\DoxyCodeLine{01417\ \ \ \}}
\DoxyCodeLine{01418\ }
\DoxyCodeLine{01419\ \ \ \textcolor{keywordtype}{int}\ pipe\_fd[2];}
\DoxyCodeLine{01420\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(pipe(pipe\_fd)\ !=\ -\/1);}
\DoxyCodeLine{01421\ \ \ \textcolor{comment}{//\ Clear\ the\ close-\/on-\/exec\ flag\ on\ the\ write\ end\ of\ the\ pipe,\ lest}}
\DoxyCodeLine{01422\ \ \ \textcolor{comment}{//\ it\ be\ closed\ when\ the\ child\ process\ does\ an\ exec:}}
\DoxyCodeLine{01423\ \ \ GTEST\_DEATH\_TEST\_CHECK\_(fcntl(pipe\_fd[1],\ F\_SETFD,\ 0)\ !=\ -\/1);}
\DoxyCodeLine{01424\ }
\DoxyCodeLine{01425\ \ \ \textcolor{keyword}{const}\ std::string\ filter\_flag\ =\ std::string(\textcolor{stringliteral}{"{}-\/-\/"{}})\ +\ GTEST\_FLAG\_PREFIX\_\ +}
\DoxyCodeLine{01426\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}filter="{}}\ +\ info-\/>test\_suite\_name()\ +\ \textcolor{stringliteral}{"{}."{}}\ +}
\DoxyCodeLine{01427\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ info-\/>name();}
\DoxyCodeLine{01428\ \ \ \textcolor{keyword}{const}\ std::string\ internal\_flag\ =\ std::string(\textcolor{stringliteral}{"{}-\/-\/"{}})\ +\ GTEST\_FLAG\_PREFIX\_\ +}
\DoxyCodeLine{01429\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}internal\_run\_death\_test="{}}\ +\ file\_\ +\ \textcolor{stringliteral}{"{}|"{}}\ +}
\DoxyCodeLine{01430\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StreamableToString(line\_)\ +\ \textcolor{stringliteral}{"{}|"{}}\ +}
\DoxyCodeLine{01431\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StreamableToString(death\_test\_index)\ +\ \textcolor{stringliteral}{"{}|"{}}\ +}
\DoxyCodeLine{01432\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StreamableToString(pipe\_fd[1]);}
\DoxyCodeLine{01433\ \ \ Arguments\ args;}
\DoxyCodeLine{01434\ \ \ args.AddArguments(GetArgvsForDeathTestChildProcess());}
\DoxyCodeLine{01435\ \ \ args.AddArgument(filter\_flag.c\_str());}
\DoxyCodeLine{01436\ \ \ args.AddArgument(internal\_flag.c\_str());}
\DoxyCodeLine{01437\ }
\DoxyCodeLine{01438\ \ \ DeathTest::set\_last\_death\_test\_message(\textcolor{stringliteral}{"{}"{}});}
\DoxyCodeLine{01439\ }
\DoxyCodeLine{01440\ \ \ CaptureStderr();}
\DoxyCodeLine{01441\ \ \ \textcolor{comment}{//\ See\ the\ comment\ in\ NoExecDeathTest::AssumeRole\ for\ why\ the\ next\ line}}
\DoxyCodeLine{01442\ \ \ \textcolor{comment}{//\ is\ necessary.}}
\DoxyCodeLine{01443\ \ \ FlushInfoLog();}
\DoxyCodeLine{01444\ }
\DoxyCodeLine{01445\ \ \ \textcolor{keyword}{const}\ pid\_t\ child\_pid\ =\ ExecDeathTestSpawnChild(args.Argv(),\ pipe\_fd[0]);}
\DoxyCodeLine{01446\ \ \ GTEST\_DEATH\_TEST\_CHECK\_SYSCALL\_(close(pipe\_fd[1]));}
\DoxyCodeLine{01447\ \ \ set\_child\_pid(child\_pid);}
\DoxyCodeLine{01448\ \ \ set\_read\_fd(pipe\_fd[0]);}
\DoxyCodeLine{01449\ \ \ set\_spawned(\textcolor{keyword}{true});}
\DoxyCodeLine{01450\ \ \ \textcolor{keywordflow}{return}\ OVERSEE\_TEST;}
\DoxyCodeLine{01451\ \}}
\DoxyCodeLine{01452\ }
\DoxyCodeLine{01453\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ !GTEST\_OS\_WINDOWS}}
\DoxyCodeLine{01454\ }
\DoxyCodeLine{01455\ \textcolor{comment}{//\ Creates\ a\ concrete\ DeathTest-\/derived\ class\ that\ depends\ on\ the}}
\DoxyCodeLine{01456\ \textcolor{comment}{//\ -\/-\/gtest\_death\_test\_style\ flag,\ and\ sets\ the\ pointer\ pointed\ to}}
\DoxyCodeLine{01457\ \textcolor{comment}{//\ by\ the\ "{}test"{}\ argument\ to\ its\ address.\ \ If\ the\ test\ should\ be}}
\DoxyCodeLine{01458\ \textcolor{comment}{//\ skipped,\ sets\ that\ pointer\ to\ NULL.\ \ Returns\ true,\ unless\ the}}
\DoxyCodeLine{01459\ \textcolor{comment}{//\ flag\ is\ set\ to\ an\ invalid\ value.}}
\DoxyCodeLine{01460\ \textcolor{keywordtype}{bool}\ DefaultDeathTestFactory::Create(\textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ statement,}
\DoxyCodeLine{01461\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Matcher<const\ std::string\&>\ matcher,}
\DoxyCodeLine{01462\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{char}*\ file,\ \textcolor{keywordtype}{int}\ line,}
\DoxyCodeLine{01463\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ DeathTest**\ test)\ \{}
\DoxyCodeLine{01464\ \ \ UnitTestImpl*\ \textcolor{keyword}{const}\ impl\ =\ GetUnitTestImpl();}
\DoxyCodeLine{01465\ \ \ \textcolor{keyword}{const}\ InternalRunDeathTestFlag*\ \textcolor{keyword}{const}\ flag\ =}
\DoxyCodeLine{01466\ \ \ \ \ \ \ impl-\/>internal\_run\_death\_test\_flag();}
\DoxyCodeLine{01467\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ death\_test\_index\ =\ impl-\/>current\_test\_info()}
\DoxyCodeLine{01468\ \ \ \ \ \ \ -\/>increment\_death\_test\_count();}
\DoxyCodeLine{01469\ }
\DoxyCodeLine{01470\ \ \ \textcolor{keywordflow}{if}\ (flag\ !=\ \textcolor{keyword}{nullptr})\ \{}
\DoxyCodeLine{01471\ \ \ \ \ \textcolor{keywordflow}{if}\ (death\_test\_index\ >\ flag-\/>index())\ \{}
\DoxyCodeLine{01472\ \ \ \ \ \ \ DeathTest::set\_last\_death\_test\_message(}
\DoxyCodeLine{01473\ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}Death\ test\ count\ ("{}}\ +\ StreamableToString(death\_test\_index)}
\DoxyCodeLine{01474\ \ \ \ \ \ \ \ \ \ \ +\ \textcolor{stringliteral}{"{})\ somehow\ exceeded\ expected\ maximum\ ("{}}}
\DoxyCodeLine{01475\ \ \ \ \ \ \ \ \ \ \ +\ StreamableToString(flag-\/>index())\ +\ \textcolor{stringliteral}{"{})"{}});}
\DoxyCodeLine{01476\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01477\ \ \ \ \ \}}
\DoxyCodeLine{01478\ }
\DoxyCodeLine{01479\ \ \ \ \ \textcolor{keywordflow}{if}\ (!(flag-\/>file()\ ==\ file\ \&\&\ flag-\/>line()\ ==\ line\ \&\&}
\DoxyCodeLine{01480\ \ \ \ \ \ \ \ \ \ \ flag-\/>index()\ ==\ death\_test\_index))\ \{}
\DoxyCodeLine{01481\ \ \ \ \ \ \ *test\ =\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01482\ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01483\ \ \ \ \ \}}
\DoxyCodeLine{01484\ \ \ \}}
\DoxyCodeLine{01485\ }
\DoxyCodeLine{01486\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_WINDOWS}}
\DoxyCodeLine{01487\ }
\DoxyCodeLine{01488\ \ \ \textcolor{keywordflow}{if}\ (GTEST\_FLAG\_GET(death\_test\_style)\ ==\ \textcolor{stringliteral}{"{}threadsafe"{}}\ ||}
\DoxyCodeLine{01489\ \ \ \ \ \ \ GTEST\_FLAG\_GET(death\_test\_style)\ ==\ \textcolor{stringliteral}{"{}fast"{}})\ \{}
\DoxyCodeLine{01490\ \ \ \ \ *test\ =\ \textcolor{keyword}{new}\ WindowsDeathTest(statement,\ std::move(matcher),\ file,\ line);}
\DoxyCodeLine{01491\ \ \ \}}
\DoxyCodeLine{01492\ }
\DoxyCodeLine{01493\ \textcolor{preprocessor}{\#\ elif\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{01494\ }
\DoxyCodeLine{01495\ \ \ \textcolor{keywordflow}{if}\ (GTEST\_FLAG\_GET(death\_test\_style)\ ==\ \textcolor{stringliteral}{"{}threadsafe"{}}\ ||}
\DoxyCodeLine{01496\ \ \ \ \ \ \ GTEST\_FLAG\_GET(death\_test\_style)\ ==\ \textcolor{stringliteral}{"{}fast"{}})\ \{}
\DoxyCodeLine{01497\ \ \ \ \ *test\ =\ \textcolor{keyword}{new}\ FuchsiaDeathTest(statement,\ std::move(matcher),\ file,\ line);}
\DoxyCodeLine{01498\ \ \ \}}
\DoxyCodeLine{01499\ }
\DoxyCodeLine{01500\ \textcolor{preprocessor}{\#\ else}}
\DoxyCodeLine{01501\ }
\DoxyCodeLine{01502\ \ \ \textcolor{keywordflow}{if}\ (GTEST\_FLAG\_GET(death\_test\_style)\ ==\ \textcolor{stringliteral}{"{}threadsafe"{}})\ \{}
\DoxyCodeLine{01503\ \ \ \ \ *test\ =\ \textcolor{keyword}{new}\ ExecDeathTest(statement,\ std::move(matcher),\ file,\ line);}
\DoxyCodeLine{01504\ \ \ \}\ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (GTEST\_FLAG\_GET(death\_test\_style)\ ==\ \textcolor{stringliteral}{"{}fast"{}})\ \{}
\DoxyCodeLine{01505\ \ \ \ \ *test\ =\ \textcolor{keyword}{new}\ NoExecDeathTest(statement,\ std::move(matcher));}
\DoxyCodeLine{01506\ \ \ \}}
\DoxyCodeLine{01507\ }
\DoxyCodeLine{01508\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_WINDOWS}}
\DoxyCodeLine{01509\ }
\DoxyCodeLine{01510\ \ \ \textcolor{keywordflow}{else}\ \{\ \ \textcolor{comment}{//\ NOLINT\ -\/\ this\ is\ more\ readable\ than\ unbalanced\ brackets\ inside\ \#if.}}
\DoxyCodeLine{01511\ \ \ \ \ DeathTest::set\_last\_death\_test\_message(\textcolor{stringliteral}{"{}Unknown\ death\ test\ style\ \(\backslash\)"{}"{}}\ +}
\DoxyCodeLine{01512\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GTEST\_FLAG\_GET(death\_test\_style)\ +}
\DoxyCodeLine{01513\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}\(\backslash\)"{}\ encountered"{}});}
\DoxyCodeLine{01514\ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{false};}
\DoxyCodeLine{01515\ \ \ \}}
\DoxyCodeLine{01516\ }
\DoxyCodeLine{01517\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{true};}
\DoxyCodeLine{01518\ \}}
\DoxyCodeLine{01519\ }
\DoxyCodeLine{01520\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_WINDOWS}}
\DoxyCodeLine{01521\ \textcolor{comment}{//\ Recreates\ the\ pipe\ and\ event\ handles\ from\ the\ provided\ parameters,}}
\DoxyCodeLine{01522\ \textcolor{comment}{//\ signals\ the\ event,\ and\ returns\ a\ file\ descriptor\ wrapped\ around\ the\ pipe}}
\DoxyCodeLine{01523\ \textcolor{comment}{//\ handle.\ This\ function\ is\ called\ in\ the\ child\ process\ only.}}
\DoxyCodeLine{01524\ \textcolor{keyword}{static}\ \textcolor{keywordtype}{int}\ GetStatusFileDescriptor(\textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ parent\_process\_id,}
\DoxyCodeLine{01525\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ write\_handle\_as\_size\_t,}
\DoxyCodeLine{01526\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ event\_handle\_as\_size\_t)\ \{}
\DoxyCodeLine{01527\ \ \ AutoHandle\ parent\_process\_handle(::OpenProcess(PROCESS\_DUP\_HANDLE,}
\DoxyCodeLine{01528\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FALSE,\ \ \textcolor{comment}{//\ Non-\/inheritable.}}
\DoxyCodeLine{01529\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ parent\_process\_id));}
\DoxyCodeLine{01530\ \ \ \textcolor{keywordflow}{if}\ (parent\_process\_handle.Get()\ ==\ INVALID\_HANDLE\_VALUE)\ \{}
\DoxyCodeLine{01531\ \ \ \ \ DeathTestAbort(\textcolor{stringliteral}{"{}Unable\ to\ open\ parent\ process\ "{}}\ +}
\DoxyCodeLine{01532\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StreamableToString(parent\_process\_id));}
\DoxyCodeLine{01533\ \ \ \}}
\DoxyCodeLine{01534\ }
\DoxyCodeLine{01535\ \ \ GTEST\_CHECK\_(\textcolor{keyword}{sizeof}(HANDLE)\ <=\ \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{size\_t}));}
\DoxyCodeLine{01536\ }
\DoxyCodeLine{01537\ \ \ \textcolor{keyword}{const}\ HANDLE\ write\_handle\ =}
\DoxyCodeLine{01538\ \ \ \ \ \ \ \textcolor{keyword}{reinterpret\_cast<}HANDLE\textcolor{keyword}{>}(write\_handle\_as\_size\_t);}
\DoxyCodeLine{01539\ \ \ HANDLE\ dup\_write\_handle;}
\DoxyCodeLine{01540\ }
\DoxyCodeLine{01541\ \ \ \textcolor{comment}{//\ The\ newly\ initialized\ handle\ is\ accessible\ only\ in\ the\ parent}}
\DoxyCodeLine{01542\ \ \ \textcolor{comment}{//\ process.\ To\ obtain\ one\ accessible\ within\ the\ child,\ we\ need\ to\ use}}
\DoxyCodeLine{01543\ \ \ \textcolor{comment}{//\ DuplicateHandle.}}
\DoxyCodeLine{01544\ \ \ \textcolor{keywordflow}{if}\ (!::DuplicateHandle(parent\_process\_handle.Get(),\ write\_handle,}
\DoxyCodeLine{01545\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ::GetCurrentProcess(),\ \&dup\_write\_handle,}
\DoxyCodeLine{01546\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0x0,\ \ \ \ \textcolor{comment}{//\ Requested\ privileges\ ignored\ since}}
\DoxyCodeLine{01547\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ DUPLICATE\_SAME\_ACCESS\ is\ used.}}
\DoxyCodeLine{01548\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FALSE,\ \ \textcolor{comment}{//\ Request\ non-\/inheritable\ handler.}}
\DoxyCodeLine{01549\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ DUPLICATE\_SAME\_ACCESS))\ \{}
\DoxyCodeLine{01550\ \ \ \ \ DeathTestAbort(\textcolor{stringliteral}{"{}Unable\ to\ duplicate\ the\ pipe\ handle\ "{}}\ +}
\DoxyCodeLine{01551\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StreamableToString(write\_handle\_as\_size\_t)\ +}
\DoxyCodeLine{01552\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}\ from\ the\ parent\ process\ "{}}\ +}
\DoxyCodeLine{01553\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StreamableToString(parent\_process\_id));}
\DoxyCodeLine{01554\ \ \ \}}
\DoxyCodeLine{01555\ }
\DoxyCodeLine{01556\ \ \ \textcolor{keyword}{const}\ HANDLE\ event\_handle\ =\ \textcolor{keyword}{reinterpret\_cast<}HANDLE\textcolor{keyword}{>}(event\_handle\_as\_size\_t);}
\DoxyCodeLine{01557\ \ \ HANDLE\ dup\_event\_handle;}
\DoxyCodeLine{01558\ }
\DoxyCodeLine{01559\ \ \ \textcolor{keywordflow}{if}\ (!::DuplicateHandle(parent\_process\_handle.Get(),\ event\_handle,}
\DoxyCodeLine{01560\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ::GetCurrentProcess(),\ \&dup\_event\_handle,}
\DoxyCodeLine{01561\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 0x0,}
\DoxyCodeLine{01562\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ FALSE,}
\DoxyCodeLine{01563\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ DUPLICATE\_SAME\_ACCESS))\ \{}
\DoxyCodeLine{01564\ \ \ \ \ DeathTestAbort(\textcolor{stringliteral}{"{}Unable\ to\ duplicate\ the\ event\ handle\ "{}}\ +}
\DoxyCodeLine{01565\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StreamableToString(event\_handle\_as\_size\_t)\ +}
\DoxyCodeLine{01566\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}\ from\ the\ parent\ process\ "{}}\ +}
\DoxyCodeLine{01567\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StreamableToString(parent\_process\_id));}
\DoxyCodeLine{01568\ \ \ \}}
\DoxyCodeLine{01569\ }
\DoxyCodeLine{01570\ \ \ \textcolor{keyword}{const}\ \textcolor{keywordtype}{int}\ write\_fd\ =}
\DoxyCodeLine{01571\ \ \ \ \ \ \ ::\_open\_osfhandle(\textcolor{keyword}{reinterpret\_cast<}intptr\_t\textcolor{keyword}{>}(dup\_write\_handle),\ O\_APPEND);}
\DoxyCodeLine{01572\ \ \ \textcolor{keywordflow}{if}\ (write\_fd\ ==\ -\/1)\ \{}
\DoxyCodeLine{01573\ \ \ \ \ DeathTestAbort(\textcolor{stringliteral}{"{}Unable\ to\ convert\ pipe\ handle\ "{}}\ +}
\DoxyCodeLine{01574\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ StreamableToString(write\_handle\_as\_size\_t)\ +}
\DoxyCodeLine{01575\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{stringliteral}{"{}\ to\ a\ file\ descriptor"{}});}
\DoxyCodeLine{01576\ \ \ \}}
\DoxyCodeLine{01577\ }
\DoxyCodeLine{01578\ \ \ \textcolor{comment}{//\ Signals\ the\ parent\ that\ the\ write\ end\ of\ the\ pipe\ has\ been\ acquired}}
\DoxyCodeLine{01579\ \ \ \textcolor{comment}{//\ so\ the\ parent\ can\ release\ its\ own\ write\ end.}}
\DoxyCodeLine{01580\ \ \ ::SetEvent(dup\_event\_handle);}
\DoxyCodeLine{01581\ }
\DoxyCodeLine{01582\ \ \ \textcolor{keywordflow}{return}\ write\_fd;}
\DoxyCodeLine{01583\ \}}
\DoxyCodeLine{01584\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_WINDOWS}}
\DoxyCodeLine{01585\ }
\DoxyCodeLine{01586\ \textcolor{comment}{//\ Returns\ a\ newly\ created\ InternalRunDeathTestFlag\ object\ with\ fields}}
\DoxyCodeLine{01587\ \textcolor{comment}{//\ initialized\ from\ the\ GTEST\_FLAG(internal\_run\_death\_test)\ flag\ if}}
\DoxyCodeLine{01588\ \textcolor{comment}{//\ the\ flag\ is\ specified;\ otherwise\ returns\ NULL.}}
\DoxyCodeLine{01589\ InternalRunDeathTestFlag*\ ParseInternalRunDeathTestFlag()\ \{}
\DoxyCodeLine{01590\ \ \ \textcolor{keywordflow}{if}\ (GTEST\_FLAG\_GET(internal\_run\_death\_test)\ ==\ \textcolor{stringliteral}{"{}"{}})\ \textcolor{keywordflow}{return}\ \textcolor{keyword}{nullptr};}
\DoxyCodeLine{01591\ }
\DoxyCodeLine{01592\ \ \ \textcolor{comment}{//\ GTEST\_HAS\_DEATH\_TEST\ implies\ that\ we\ have\ ::std::string,\ so\ we}}
\DoxyCodeLine{01593\ \ \ \textcolor{comment}{//\ can\ use\ it\ here.}}
\DoxyCodeLine{01594\ \ \ \textcolor{keywordtype}{int}\ line\ =\ -\/1;}
\DoxyCodeLine{01595\ \ \ \textcolor{keywordtype}{int}\ index\ =\ -\/1;}
\DoxyCodeLine{01596\ \ \ ::std::vector<\ ::std::string>\ fields;}
\DoxyCodeLine{01597\ \ \ SplitString(GTEST\_FLAG\_GET(internal\_run\_death\_test),\ \textcolor{charliteral}{'|'},\ \&fields);}
\DoxyCodeLine{01598\ \ \ \textcolor{keywordtype}{int}\ write\_fd\ =\ -\/1;}
\DoxyCodeLine{01599\ }
\DoxyCodeLine{01600\ \textcolor{preprocessor}{\#\ if\ GTEST\_OS\_WINDOWS}}
\DoxyCodeLine{01601\ }
\DoxyCodeLine{01602\ \ \ \textcolor{keywordtype}{unsigned}\ \textcolor{keywordtype}{int}\ parent\_process\_id\ =\ 0;}
\DoxyCodeLine{01603\ \ \ \textcolor{keywordtype}{size\_t}\ write\_handle\_as\_size\_t\ =\ 0;}
\DoxyCodeLine{01604\ \ \ \textcolor{keywordtype}{size\_t}\ event\_handle\_as\_size\_t\ =\ 0;}
\DoxyCodeLine{01605\ }
\DoxyCodeLine{01606\ \ \ \textcolor{keywordflow}{if}\ (fields.size()\ !=\ 6}
\DoxyCodeLine{01607\ \ \ \ \ \ \ ||\ !ParseNaturalNumber(fields[1],\ \&line)}
\DoxyCodeLine{01608\ \ \ \ \ \ \ ||\ !ParseNaturalNumber(fields[2],\ \&index)}
\DoxyCodeLine{01609\ \ \ \ \ \ \ ||\ !ParseNaturalNumber(fields[3],\ \&parent\_process\_id)}
\DoxyCodeLine{01610\ \ \ \ \ \ \ ||\ !ParseNaturalNumber(fields[4],\ \&write\_handle\_as\_size\_t)}
\DoxyCodeLine{01611\ \ \ \ \ \ \ ||\ !ParseNaturalNumber(fields[5],\ \&event\_handle\_as\_size\_t))\ \{}
\DoxyCodeLine{01612\ \ \ \ \ DeathTestAbort(\textcolor{stringliteral}{"{}Bad\ -\/-\/gtest\_internal\_run\_death\_test\ flag:\ "{}}\ +}
\DoxyCodeLine{01613\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GTEST\_FLAG\_GET(internal\_run\_death\_test));}
\DoxyCodeLine{01614\ \ \ \}}
\DoxyCodeLine{01615\ \ \ write\_fd\ =\ GetStatusFileDescriptor(parent\_process\_id,}
\DoxyCodeLine{01616\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ write\_handle\_as\_size\_t,}
\DoxyCodeLine{01617\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ event\_handle\_as\_size\_t);}
\DoxyCodeLine{01618\ }
\DoxyCodeLine{01619\ \textcolor{preprocessor}{\#\ elif\ GTEST\_OS\_FUCHSIA}}
\DoxyCodeLine{01620\ }
\DoxyCodeLine{01621\ \ \ \textcolor{keywordflow}{if}\ (fields.size()\ !=\ 3}
\DoxyCodeLine{01622\ \ \ \ \ \ \ ||\ !ParseNaturalNumber(fields[1],\ \&line)}
\DoxyCodeLine{01623\ \ \ \ \ \ \ ||\ !ParseNaturalNumber(fields[2],\ \&index))\ \{}
\DoxyCodeLine{01624\ \ \ \ \ DeathTestAbort(\textcolor{stringliteral}{"{}Bad\ -\/-\/gtest\_internal\_run\_death\_test\ flag:\ "{}}\ +}
\DoxyCodeLine{01625\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GTEST\_FLAG\_GET(internal\_run\_death\_test));}
\DoxyCodeLine{01626\ \ \ \}}
\DoxyCodeLine{01627\ }
\DoxyCodeLine{01628\ \textcolor{preprocessor}{\#\ else}}
\DoxyCodeLine{01629\ }
\DoxyCodeLine{01630\ \ \ \textcolor{keywordflow}{if}\ (fields.size()\ !=\ 4}
\DoxyCodeLine{01631\ \ \ \ \ \ \ ||\ !ParseNaturalNumber(fields[1],\ \&line)}
\DoxyCodeLine{01632\ \ \ \ \ \ \ ||\ !ParseNaturalNumber(fields[2],\ \&index)}
\DoxyCodeLine{01633\ \ \ \ \ \ \ ||\ !ParseNaturalNumber(fields[3],\ \&write\_fd))\ \{}
\DoxyCodeLine{01634\ \ \ \ \ DeathTestAbort(\textcolor{stringliteral}{"{}Bad\ -\/-\/gtest\_internal\_run\_death\_test\ flag:\ "{}}\ +}
\DoxyCodeLine{01635\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ GTEST\_FLAG\_GET(internal\_run\_death\_test));}
\DoxyCodeLine{01636\ \ \ \}}
\DoxyCodeLine{01637\ }
\DoxyCodeLine{01638\ \textcolor{preprocessor}{\#\ endif\ \ }\textcolor{comment}{//\ GTEST\_OS\_WINDOWS}}
\DoxyCodeLine{01639\ }
\DoxyCodeLine{01640\ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ InternalRunDeathTestFlag(fields[0],\ line,\ index,\ write\_fd);}
\DoxyCodeLine{01641\ \}}
\DoxyCodeLine{01642\ }
\DoxyCodeLine{01643\ \}\ \ \textcolor{comment}{//\ namespace\ internal}}
\DoxyCodeLine{01644\ }
\DoxyCodeLine{01645\ \textcolor{preprocessor}{\#endif\ \ }\textcolor{comment}{//\ GTEST\_HAS\_DEATH\_TEST}}
\DoxyCodeLine{01646\ }
\DoxyCodeLine{01647\ \}\ \ \textcolor{comment}{//\ namespace\ testing}}

\end{DoxyCode}
